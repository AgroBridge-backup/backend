
 RUN  v1.6.1 /Users/mac/Documents/agrobridge-backend/apps/api

 âœ“ tests/unit/notifications/MetricsCollector.test.ts  (9 tests) 47ms
 â¯ tests/unit/notifications/NotificationQueue.test.ts  (7 tests | 4 failed) 51ms
   â¯ tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > pause and resume > should pause the queue
     â†’ expected "spy" to be called at least once
   â¯ tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > pause and resume > should resume the queue
     â†’ expected "spy" to be called at least once
   â¯ tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > clean > should clean old jobs
     â†’ expected "spy" to be called at least once
   â¯ tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > shutdown > should close the queue gracefully
     â†’ expected "spy" to be called at least once
stdout | unknown test
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with InvalidTokenError if auth header is missing
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with InvalidTokenError if token is not Bearer
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with InvalidTokenError if token is blacklisted
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: valid-token...
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: mock-user-id

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with CustomTokenExpiredError if jwt.verify throws TokenExpiredError
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: expired-token...
2025-12-12 19:09:25 [31merror[39m: [AuthMiddleware] Token verification failed: 

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with InvalidTokenError if jwt.verify throws a generic error
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: invalid-signature-to...
2025-12-12 19:09:25 [31merror[39m: [AuthMiddleware] Token verification failed: Invalid signature

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should call next with InsufficientPermissionsError if user role is not in required roles
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: producer-token...
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: mock-user-id

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should attach user to request and call next if token is valid and role is sufficient
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: admin-token...
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: mock-user-id

stdout | tests/presentation/middlewares/auth.middleware.test.ts > Authentication Middleware > should succeed if no roles are required and token is valid
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Authenticating request for: undefined
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token received: any-role-token...
2025-12-12 19:09:25 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: mock-user-id

 âœ“ tests/presentation/middlewares/auth.middleware.test.ts  (8 tests) 14ms
 âœ“ tests/e2e/notifications/notifications.routes.test.ts  (13 tests) 76ms
 âœ“ tests/unit/notifications/SMSService.test.ts  (8 tests) 35ms
stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: Redis client connected

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: Redis client connected

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: Redis client connected

 âœ“ tests/unit/domain/Password.test.ts  (17 tests) 4ms
stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: Redis client connected

 âœ“ tests/unit/notifications/EmailService.test.ts  (6 tests) 87ms
 âœ“ tests/unit/notifications/FCMService.test.ts  (5 tests) 26ms
 âœ“ tests/unit/producers/ListProducersUseCase.test.ts  (2 tests) 2ms
stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Loading Public Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key.pub

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: Redis client connected

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Loading Private Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Loading Private Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Loading Private Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Loading Private Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: [NotificationQueue] Queue initialized successfully
{
  "redis": "localhost:6379",
  "db": 0
}
2025-12-12 19:09:26 [32minfo[39m: [BullBoard] Dashboard initialized
{
  "basePath": "/admin/queues"
}

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: [NotificationQueue] Queue initialized successfully
{
  "redis": "localhost:6379",
  "db": 0
}
2025-12-12 19:09:26 [32minfo[39m: [BullBoard] Dashboard initialized
{
  "basePath": "/admin/queues"
}

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: [NotificationQueue] Queue initialized successfully
{
  "redis": "localhost:6379",
  "db": 0
}
2025-12-12 19:09:26 [32minfo[39m: [BullBoard] Dashboard initialized
{
  "basePath": "/admin/queues"
}

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: [NotificationQueue] Queue initialized successfully
{
  "redis": "localhost:6379",
  "db": 0
}
2025-12-12 19:09:26 [32minfo[39m: [BullBoard] Dashboard initialized
{
  "basePath": "/admin/queues"
}

stdout | unknown test
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Loading Private Key from: /Users/mac/Documents/agrobridge-backend/apps/api/jwtRS256.key

stdout | unknown test
2025-12-12 19:09:26 [32minfo[39m: [NotificationQueue] Queue initialized successfully
{
  "redis": "localhost:6379",
  "db": 0
}
2025-12-12 19:09:26 [32minfo[39m: [BullBoard] Dashboard initialized
{
  "basePath": "/admin/queues"
}

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [32minfo[39m: Start seeding...

stdout | tests/e2e/event.e2e.test.ts > Event API E2E
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: producer@test.com

stdout | tests/e2e/batches.e2e.test.ts > Batches API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: producer-batch-1765588166595@test.com

stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: admin-producers-1765588166586@test.com

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/login > should fail with wrong credentials
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: wrong@test.com
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": false,
  "hasProducer": false
}
2025-12-12 19:09:26 [31merror[39m: Invalid credentials or user inactive.
AuthenticationError: Invalid credentials or user inactive.
    at LoginUseCase.execute (/Users/mac/Documents/agrobridge-backend/apps/api/src/application/use-cases/auth/LoginUseCase.ts:37:13)
    at /Users/mac/Documents/agrobridge-backend/apps/api/src/presentation/routes/auth.routes.ts:28:24
{
  "path": "/api/v1/auth/login",
  "method": "POST"
}
2025-12-12 19:09:26 [33mwarn[39m: [Performance] Client error - POST /api/v1/auth/login returned 401 in 5ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 401 81 - 6.185 ms

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [32minfo[39m: Upserted admin user: admin@test.com

stdout | tests/e2e/event.e2e.test.ts > Event API E2E
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": true,
  "producerId": "6046b507-b2dd-4cf3-86e8-75e12d59218a"
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for producer@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 3ad30bcc-824e-4a76-98db-3fb60a20a16a]
{
  "email": "producer@test.com"
}

stdout | tests/e2e/event.e2e.test.ts > Event API E2E
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 93ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1285 - 93.695 ms

stdout | tests/e2e/event.e2e.test.ts > Event API E2E > POST /api/v1/events should fail for unauthorized user
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [31merror[39m: Authorization header missing or malformed
InvalidTokenError: Authorization header missing or malformed
    at /Users/mac/Documents/agrobridge-backend/apps/api/src/presentation/middlewares/auth.middleware.ts:38:15
    at newFn (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express-async-errors/index.js:16:20)
    at Layer.handle [as handle_request] (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/route.js:149:13)
    at Route.dispatch (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/route.js:119:3)
    at newFn (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express-async-errors/index.js:16:20)
    at Layer.handle [as handle_request] (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/layer.js:95:5)
    at /Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:346:12)
    at next (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:280:10)
{
  "path": "/api/v1/events",
  "method": "POST"
}
2025-12-12 19:09:26 [33mwarn[39m: [Performance] Client error - POST /api/v1/events returned 401 in 1ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/events HTTP/1.1 401 83 - 1.348 ms

stdout | tests/e2e/batches.e2e.test.ts > Batches API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": true,
  "producerId": "77644a32-c305-45fc-ad03-0646167a2a6c"
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for producer-batch-1765588166595@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 6a704fd7-7433-439e-9f66-6679f6d2961f]
{
  "email": "producer-batch-1765588166595@test.com"
}

stdout | tests/e2e/batches.e2e.test.ts > Batches API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 83ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1311 - 83.785 ms

 âœ“ tests/e2e/event.e2e.test.ts  (1 test) 135ms
stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": false
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for admin-producers-1765588166586@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: e010eae8-6871-4fa7-8600-b14a7171cc9d]
{
  "email": "admin-producers-1765588166586@test.com"
}

stdout | tests/e2e/batches.e2e.test.ts > Batches API (E2E) > POST /api/v1/batches should return 201 when creating a new batch with a producer token
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: 6a704fd7-7433-439e-9f66-6679f6d2961f
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST / completed in 2ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/batches HTTP/1.1 201 410 - 2.119 ms

stdout | tests/e2e/batches.e2e.test.ts > Batches API (E2E) > GET /api/v1/batches/:id should retrieve the created batch
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /dummy-e2e-batch-id-123
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: 6a704fd7-7433-439e-9f66-6679f6d2961f
2025-12-12 19:09:26 [34mdebug[39m: [Performance] GET /dummy-e2e-batch-id-123 completed in 1ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - GET /api/v1/batches/dummy-e2e-batch-id-123 HTTP/1.1 200 85 - 1.005 ms

stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 84ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1239 - 84.632 ms

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/login > should succeed with correct credentials and return tokens
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: admin-1765588166589@test.com
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": false
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for admin-1765588166589@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 6ce132dc-6b42-4c37-b5ca-1a3569905651]
{
  "email": "admin-1765588166589@test.com"
}

stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E) > GET /api/v1/producers > should return the first page of producers
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: e010eae8-6871-4fa7-8600-b14a7171cc9d

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/login > should succeed with correct credentials and return tokens
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 80ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1226 - 80.069 ms

 âœ“ tests/e2e/batches.e2e.test.ts  (2 tests) 243ms
stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E) > GET /api/v1/producers > should return the first page of producers
2025-12-12 19:09:26 [34mdebug[39m: [Performance] GET / completed in 10ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - GET /api/v1/producers?page=1&limit=10 HTTP/1.1 200 3315 - 9.635 ms

stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E) > GET /api/v1/producers > should filter whitelisted producers
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: e010eae8-6871-4fa7-8600-b14a7171cc9d

stdout | tests/e2e/producers.e2e.test.ts > Producers API (E2E) > GET /api/v1/producers > should filter whitelisted producers
2025-12-12 19:09:26 [34mdebug[39m: [Performance] GET / completed in 4ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - GET /api/v1/producers?isWhitelisted=true HTTP/1.1 200 1986 - 4.507 ms

 âœ“ tests/e2e/producers.e2e.test.ts  (2 tests) 271ms
stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [32minfo[39m: Upserted producer user: producer@test.com

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [32minfo[39m: Upserted second producer user: producer2@test.com
2025-12-12 19:09:26 [32minfo[39m: Seeding finished.

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: admin@test.com

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: admin-1765588166589@test.com
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": false
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for admin-1765588166589@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 6ce132dc-6b42-4c37-b5ca-1a3569905651]
{
  "email": "admin-1765588166589@test.com"
}

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 79ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1226 - 79.314 ms

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /me
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: 6ce132dc-6b42-4c37-b5ca-1a3569905651

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
2025-12-12 19:09:26 [34mdebug[39m: [Performance] GET /me completed in 3ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - GET /api/v1/auth/me HTTP/1.1 200 295 - 3.228 ms

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": false
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for admin@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 6712ff11-c21f-4ac6-9a44-d61bb28e4f85]
{
  "email": "admin@test.com"
}

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E)
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 81ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1207 - 80.807 ms

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E) > POST /api/v1/events should register a new event for a batch
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: 6712ff11-c21f-4ac6-9a44-d61bb28e4f85

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E) > POST /api/v1/events should register a new event for a batch
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST / completed in 2ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/events HTTP/1.1 201 264 - 2.389 ms

stdout | tests/e2e/events.e2e.test.ts > Events API (E2E) > POST /api/v1/events should fail for unauthorized user
2025-12-12 19:09:26 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /
2025-12-12 19:09:26 [31merror[39m: Authorization header missing or malformed
InvalidTokenError: Authorization header missing or malformed
    at /Users/mac/Documents/agrobridge-backend/apps/api/src/presentation/middlewares/auth.middleware.ts:38:15
    at newFn (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express-async-errors/index.js:16:20)
    at Layer.handle [as handle_request] (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/route.js:149:13)
    at Route.dispatch (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/route.js:119:3)
    at newFn (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express-async-errors/index.js:16:20)
    at Layer.handle [as handle_request] (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/layer.js:95:5)
    at /Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:346:12)
    at next (/Users/mac/Documents/agrobridge-backend/apps/api/node_modules/express/lib/router/index.js:280:10)
{
  "path": "/api/v1/events",
  "method": "POST"
}
2025-12-12 19:09:26 [33mwarn[39m: [Performance] Client error - POST /api/v1/events returned 401 in 1ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/events HTTP/1.1 401 83 - 1.154 ms

 âœ“ tests/e2e/events.e2e.test.ts  (2 tests) 384ms
stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/refresh > should return new tokens and revoke the old refresh token
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Attempting to log in user: producer-1765588166589@test.com
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] User found in database.
{
  "userFound": true,
  "hasProducer": true,
  "producerId": "3655dcae-7afc-4252-b556-09e0c60adb97"
}
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Password validation result for producer-1765588166589@test.com: true
2025-12-12 19:09:26 [34mdebug[39m: [LoginUseCase] Generating tokens for user. [UserID: 0566ed34-739a-444c-bad1-ec20daeedc91]
{
  "email": "producer-1765588166589@test.com"
}

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/refresh > should return new tokens and revoke the old refresh token
2025-12-12 19:09:26 [34mdebug[39m: [Performance] POST /login completed in 71ms
2025-12-12 19:09:26 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/login HTTP/1.1 200 1303 - 71.023 ms

stdout | tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/refresh > should return new tokens and revoke the old refresh token
2025-12-12 19:09:27 [34mdebug[39m: [Performance] POST /refresh completed in 5ms
2025-12-12 19:09:27 [32minfo[39m: ::ffff:127.0.0.1 - POST /api/v1/auth/refresh HTTP/1.1 200 1234 - 5.410 ms
2025-12-12 19:09:27 [34mdebug[39m: [AuthMiddleware] Authenticating request for: /me
2025-12-12 19:09:27 [34mdebug[39m: [AuthMiddleware] Token received: eyJhbGciOiJSUzI1NiIs...
2025-12-12 19:09:27 [34mdebug[39m: [AuthMiddleware] Token verified successfully for user: 0566ed34-739a-444c-bad1-ec20daeedc91
2025-12-12 19:09:27 [34mdebug[39m: [Performance] GET /me completed in 1ms
2025-12-12 19:09:27 [32minfo[39m: ::ffff:127.0.0.1 - GET /api/v1/auth/me HTTP/1.1 200 304 - 1.493 ms

 â¯ tests/e2e/auth.e2e.test.ts  (4 tests | 2 failed) 426ms
   â¯ tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
     â†’ expected undefined to be 'admin-1765588166589@test.com' // Object.is equality
   â¯ tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/refresh > should return new tokens and revoke the old refresh token
     â†’ expected undefined to be 'producer-1765588166589@test.com' // Object.is equality

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 6 â¯â¯â¯â¯â¯â¯â¯

 FAIL  tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/logout > should blacklist the token, preventing further access
AssertionError: expected undefined to be 'admin-1765588166589@test.com' // Object.is equality

- Expected: 
"admin-1765588166589@test.com"

+ Received: 
undefined

 â¯ tests/e2e/auth.e2e.test.ts:136:33
    134|       const meRes1 = await request.get('/api/v1/auth/me').set('Authoriâ€¦
    135|       expect(meRes1.status).toBe(200);
    136|       expect(meRes1.body.email).toBe(adminEmail);
       |                                 ^
    137| 
    138|       const logoutRes = await request.post('/api/v1/auth/logout').set(â€¦

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/6]â¯

 FAIL  tests/e2e/auth.e2e.test.ts > Auth API E2E > POST /api/v1/auth/refresh > should return new tokens and revoke the old refresh token
AssertionError: expected undefined to be 'producer-1765588166589@test.com' // Object.is equality

- Expected: 
"producer-1765588166589@test.com"

+ Received: 
undefined

 â¯ tests/e2e/auth.e2e.test.ts:166:32
    164|       const meRes = await request.get('/api/v1/auth/me').set('Authorizâ€¦
    165|       expect(meRes.status).toBe(200);
    166|       expect(meRes.body.email).toBe(producerEmail);
       |                                ^
    167| 
    168|       const refreshRes2 = await request.post('/api/v1/auth/refresh').sâ€¦

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/6]â¯

 FAIL  tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > pause and resume > should pause the queue
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/notifications/NotificationQueue.test.ts:179:31
    177|       await queue.pause();
    178| 
    179|       expect(mockQueue.pause).toHaveBeenCalled();
       |                               ^
    180|     });
    181| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/6]â¯

 FAIL  tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > pause and resume > should resume the queue
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/notifications/NotificationQueue.test.ts:190:32
    188|       await queue.resume();
    189| 
    190|       expect(mockQueue.resume).toHaveBeenCalled();
       |                                ^
    191|     });
    192|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/6]â¯

 FAIL  tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > clean > should clean old jobs
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/notifications/NotificationQueue.test.ts:203:31
    201|       await queue.clean(24);
    202| 
    203|       expect(mockQueue.clean).toHaveBeenCalled();
       |                               ^
    204|     });
    205|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/6]â¯

 FAIL  tests/unit/notifications/NotificationQueue.test.ts > NotificationQueue > shutdown > should close the queue gracefully
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/notifications/NotificationQueue.test.ts:216:31
    214|       await queue.shutdown();
    215| 
    216|       expect(mockQueue.close).toHaveBeenCalled();
       |                               ^
    217|     });
    218|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/6]â¯

 Test Files  2 failed | 12 passed (14)
      Tests  6 failed | 80 passed (86)
   Start at  19:09:25
   Duration  1.55s (transform 536ms, setup 179ms, collect 4.25s, tests 1.80s, environment 1ms, prepare 950ms)

