generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PRODUCER
  CERTIFIER
  BUYER
}

enum BatchStatus {
  REGISTERED
  IN_TRANSIT
  ARRIVED
  DELIVERED
  REJECTED
}

enum EventType {
  HARVEST
  PROCESSING
  QUALITY_INSPECTION
  PACKAGING
  TRANSPORT_START
  TRANSPORT_ARRIVAL
  CUSTOMS_CLEARANCE
  DELIVERY
}

enum CertificationType {
  GLOBALGAP
  ORGANIC_USDA
  ORGANIC_EU
  RAINFOREST_ALLIANCE
  FAIR_TRADE
  SENASICA
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String?  // Nullable for OAuth-only users
  firstName     String
  lastName      String
  role          UserRole
  walletAddress String?  @unique
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?

  // Two-Factor Authentication (2FA)
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecret    String?  // Encrypted TOTP secret
  backupCodes        String[] @default([]) // Hashed backup codes
  twoFactorEnabledAt DateTime?

  // OAuth providers linked to this account
  oauthProviders OAuthProvider[]

  producer      Producer?
  createdEvents TraceabilityEvent[]

  // Notification system relations
  notifications           Notification[]
  deviceTokens            DeviceToken[]
  notificationPreferences NotificationPreference?

  // Payment and subscription
  subscription Subscription?

  // Export reports
  reports Report[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([walletAddress])
  @@map("users")
}

model Producer {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessName  String
  rfc           String   @unique
  state         String
  municipality  String
  address       String?
  latitude      Decimal  @db.Decimal(10, 6)
  longitude     Decimal  @db.Decimal(10, 6)
  
  totalHectares Decimal? @db.Decimal(10, 2)
  cropTypes     String[]
  
  isWhitelisted Boolean  @default(false)
  whitelistedAt DateTime?
  whitelistedBy String?
  
  batches          Batch[]
  certifications   Certification[]

  // Cash Flow Bridge Relations
  orders           Order[]
  advances         AdvanceContract[]   @relation("FarmerAdvances")
  creditScore      CreditScore?        @relation("ProducerCreditScore")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([rfc])
  @@index([isWhitelisted])
  @@index([state, municipality])
  @@map("producers")
}

model Certification {
  id                String            @id @default(uuid())
  producerId        String
  producer          Producer          @relation(fields: [producerId], references: [id], onDelete: Cascade)
  
  type              CertificationType
  certifier         String
  certificateNumber String            @unique
  ipfsHash          String?
  
  issuedAt          DateTime
  expiresAt         DateTime
  isActive          Boolean           @default(true)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([producerId, type])
  @@index([certificateNumber])
  @@index([expiresAt])
  @@map("certifications")
}

enum Variety {
  HASS
  BERRIES
}

model Batch {
  id              String      @id @default(uuid())
  producerId      String
  producer        Producer    @relation(fields: [producerId], references: [id])
  
  variety         Variety
  origin          String
  weightKg        Decimal     @db.Decimal(10, 2)
  harvestDate     DateTime
  
  blockchainHash  String
  
  status          BatchStatus @default(REGISTERED)
  
  events          TraceabilityEvent[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([producerId])
  @@index([status])
  @@index([harvestDate])
  @@map("batches")
}

model TraceabilityEvent {
  id                String    @id @default(uuid())
  batchId           String
  batch             Batch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  eventType         EventType
  timestamp         DateTime  @default(now())
  
  latitude          Decimal   @db.Decimal(10, 6)
  longitude         Decimal   @db.Decimal(10, 6)
  locationName      String?
  
  temperature       Decimal?  @db.Decimal(5, 2)
  humidity          Decimal?  @db.Decimal(5, 2)
  notes             String?   @db.Text
  
  ipfsHash          String?
  photos            String[]
  
  blockchainTxHash  String?   @unique
  blockchainEventId String?   @unique
  isVerified        Boolean   @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  
  signedByBiometric Boolean   @default(false)
  signatureHash     String?
  
  createdById       String
  createdBy         User      @relation(fields: [createdById], references: [id])
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([batchId])
  @@index([eventType])
  @@index([timestamp])
  @@index([blockchainTxHash])
  @@map("traceability_events")
}

model RefreshToken {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ════════════════════════════════════════════════════════════════════════════════
// OAUTH PROVIDER SCHEMA
// Stores linked OAuth providers (Google, GitHub) for each user
// ════════════════════════════════════════════════════════════════════════════════

/// OAuth provider types
enum OAuthProviderType {
  GOOGLE
  GITHUB
}

/// OAuth provider linked to a user account
model OAuthProvider {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider    OAuthProviderType
  providerId  String            // Provider's unique user ID
  email       String?           // Email from OAuth provider (may differ from user email)

  // Provider-specific data
  accessToken  String?          // Encrypted OAuth access token (for API calls)
  refreshToken String?          // Encrypted OAuth refresh token
  expiresAt    DateTime?        // Token expiration

  // Profile data from provider
  displayName  String?
  avatarUrl    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_providers")
}

// ════════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM SCHEMA
// Enterprise-grade multi-channel notification infrastructure
// Supports: Push (FCM/APNs), Email (SendGrid), SMS (Twilio)
// ════════════════════════════════════════════════════════════════════════════════

/// Notification type categories for the agricultural platform
enum NotificationType {
  BATCH_CREATED
  BATCH_UPDATED
  BATCH_VERIFIED
  BATCH_STATUS_CHANGED
  CERTIFICATE_READY
  CERTIFICATE_DOWNLOADED
  CERTIFICATE_EXPIRING
  SENSOR_ALERT
  SENSOR_WARNING
  ORDER_CREATED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PRODUCER_WHITELISTED
  PRODUCER_SUSPENDED
  SYSTEM_ANNOUNCEMENT
  ACCOUNT_VERIFICATION
  PASSWORD_RESET
  WELCOME
  CUSTOM
}

/// Delivery channels for notifications
enum NotificationChannel {
  PUSH      // FCM for Android, APNs for iOS
  EMAIL     // SendGrid transactional emails
  SMS       // Twilio SMS messages
  WHATSAPP  // Twilio WhatsApp Business API
  IN_APP    // Stored in database for in-app notification center
  WEBHOOK   // HTTP callback to external systems
}

/// Notification delivery status tracking
enum NotificationStatus {
  PENDING     // Queued, not yet processed
  QUEUED      // Added to Bull queue for processing
  SENT        // Sent to provider (FCM/APNs/SendGrid/Twilio)
  DELIVERED   // Confirmed delivered by provider callback
  READ        // User opened/read the notification
  CLICKED     // User clicked/interacted with notification
  FAILED      // Delivery failed after all retries
  EXPIRED     // TTL expired before delivery
  CANCELLED   // Cancelled before sending
}

/// Notification priority levels
enum NotificationPriority {
  LOW       // Marketing, announcements (can be delayed)
  NORMAL    // Standard notifications (batch updates)
  HIGH      // Important updates (certificates, orders)
  CRITICAL  // Urgent alerts (sensor alerts, security)
}

/// Mobile platform types for device tokens
enum Platform {
  IOS
  ANDROID
  WEB
}

/// Delivery attempt status for logs
enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRY
}

/// Main notification record - tracks every notification sent through the system
model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type        NotificationType
  title       String   @db.VarChar(255)
  body        String   @db.Text
  data        Json?    // Custom payload for deep linking, e.g., {"batchId": "xxx", "deepLink": "/batches/xxx"}
  imageUrl    String?  @db.VarChar(500)

  // Channels - which delivery methods to use
  channels    NotificationChannel[]

  // Status tracking
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  clickedAt   DateTime?
  failedAt    DateTime?
  errorMessage String? @db.Text

  // Metadata
  priority    NotificationPriority @default(NORMAL)
  expiresAt   DateTime?  // TTL - notification expires after this time
  retryCount  Int        @default(0)
  maxRetries  Int        @default(3)

  // Delivery logs for each channel
  deliveryLogs NotificationDeliveryLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Performance indexes
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, status])
  @@index([status, createdAt])
  @@index([type, createdAt])
  @@index([priority, status])
  @@map("notifications")
}

/// Device tokens for push notifications (iOS & Android)
model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform  Platform
  token     String   @unique @db.VarChar(500)  // FCM token or APNs device token

  // Device metadata for debugging and analytics
  deviceInfo Json?   // OS version, device model, app version, etc.

  // Status
  active    Boolean  @default(true)  // Set to false when token becomes invalid
  lastUsedAt DateTime @default(now())

  // FCM topic subscriptions
  topics    String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, active])
  @@index([platform, active])
  @@index([token])
  @@map("device_tokens")
}

/// Notification delivery logs - tracks each delivery attempt per channel
model NotificationDeliveryLog {
  id             String   @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  channel        NotificationChannel
  status         DeliveryStatus

  // Provider response data
  providerId     String?  @db.VarChar(255)  // FCM message ID, APNs ID, SendGrid ID, Twilio SID
  providerError  String?  @db.Text
  providerResponse Json?  // Full provider response for debugging

  // Timing metrics
  attemptedAt    DateTime @default(now())
  deliveredAt    DateTime?
  latencyMs      Int?     // Time from attempt to delivery confirmation

  // Retry tracking
  attempt        Int      @default(1)

  createdAt      DateTime @default(now())

  @@index([notificationId])
  @@index([channel, status])
  @@index([attemptedAt])
  @@map("notification_delivery_logs")
}

/// Notification templates - reusable notification content with variable substitution
model NotificationTemplate {
  id          String   @id @default(uuid())

  name        String   @unique @db.VarChar(100)  // e.g., "batch-created", "sensor-alert"
  type        NotificationType

  // Templates support Handlebars-style variables like {{batchId}}, {{producerName}}
  titleTemplate String  @db.VarChar(255)
  bodyTemplate  String  @db.Text

  // Email-specific templates (optional)
  emailSubject  String? @db.VarChar(255)
  emailHtml     String? @db.Text  // Full HTML email template

  // SMS-specific (optional, should be < 160 chars)
  smsTemplate   String? @db.VarChar(500)

  // Default channels and priority
  defaultChannels NotificationChannel[] @default([PUSH, EMAIL])
  defaultPriority NotificationPriority @default(NORMAL)

  // Template status
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([active])
  @@map("notification_templates")
}

/// User notification preferences - controls what notifications users receive
model NotificationPreference {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  pushEnabled   Boolean @default(true)
  emailEnabled  Boolean @default(true)
  smsEnabled    Boolean @default(false)  // SMS is opt-in due to cost
  whatsappEnabled Boolean @default(false)

  // Type-specific preferences (JSON map of NotificationType -> boolean)
  typePreferences Json @default("{}")

  // Quiet hours (no notifications during these times)
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? @db.VarChar(5)  // HH:MM format, e.g., "22:00"
  quietHoursEnd     String? @db.VarChar(5)  // HH:MM format, e.g., "08:00"
  timezone          String  @default("America/Mexico_City")

  // Contact info for SMS/WhatsApp
  phoneNumber       String? @db.VarChar(20)  // E.164 format: +521234567890
  phoneVerified     Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notification_preferences")
}

// ════════════════════════════════════════════════════════════════════════════════
// AUDIT LOGGING SYSTEM
// Enterprise-grade audit trail for compliance (FSMA, SENASICA, EU Regulations)
// 7-year retention policy for traceability requirements
// ════════════════════════════════════════════════════════════════════════════════

/// Audit action types for tracking all system operations
enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_RESET
  PASSWORD_CHANGE
  TOKEN_REFRESH

  // CRUD Operations
  CREATE
  READ
  UPDATE
  DELETE

  // Business Actions
  VERIFY_PRODUCER
  WHITELIST_PRODUCER
  SUSPEND_PRODUCER
  GENERATE_QR
  UPDATE_BATCH_STATUS
  REGISTER_EVENT
  VERIFY_EVENT
  ADD_CERTIFICATION

  // Admin Actions
  ADMIN_ACTION
  EXPORT_DATA
  BULK_OPERATION

  // Security Events
  ACCESS_DENIED
  RATE_LIMIT_EXCEEDED
  INVALID_TOKEN
  SUSPICIOUS_ACTIVITY
}

/// Audit log entry - immutable record of all system actions
model AuditLog {
  id            String      @id @default(uuid())
  userId        String?     // Can be null for system actions or unauthenticated requests
  action        AuditAction
  resource      String      // Resource type: User, Producer, Batch, Event, etc.
  resourceId    String?     // ID of the affected resource
  details       Json?       // Additional context (changes made, before/after values)
  ipAddress     String?     @db.VarChar(45) // IPv6 compatible
  userAgent     String?     @db.VarChar(500)
  correlationId String?     @db.VarChar(100) // For request tracking across services
  requestId     String?     @db.VarChar(100) // Unique request identifier

  // Result tracking
  success       Boolean     @default(true)
  errorMessage  String?     @db.Text

  // Performance metrics
  durationMs    Int?        // Request duration in milliseconds

  timestamp     DateTime    @default(now())

  // Indexes for efficient querying
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([timestamp])
  @@index([correlationId])
  @@index([success])
  @@index([userId, timestamp])
  @@index([resource, action, timestamp])
  @@map("audit_logs")
}

// ════════════════════════════════════════════════════════════════════════════════
// STRIPE PAYMENT INTEGRATION
// Subscription billing, one-time payments, and usage-based billing
// ════════════════════════════════════════════════════════════════════════════════

/// Subscription tier levels for the platform
enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

/// Subscription status tracking
enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
  PAUSED
}

/// User subscription record
model Subscription {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe identifiers
  stripeCustomerId     String  @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Subscription details
  tier        SubscriptionTier   @default(FREE)
  status      SubscriptionStatus @default(ACTIVE)

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialEnd           DateTime?

  // Usage tracking for current period
  batchesUsed     Int @default(0)
  batchesLimit    Int @default(10)
  apiCallsUsed    Int @default(0)
  apiCallsLimit   Int @default(100)
  storageUsedMb   Int @default(0)
  storageLimitMb  Int @default(100)

  // Payment history
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

/// Payment record for invoices and one-time payments
model Payment {
  id             String   @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Stripe identifiers
  stripePaymentIntentId String  @unique
  stripeInvoiceId       String?

  // Payment details
  amount      Int    // Amount in cents
  currency    String @default("usd")
  status      String // succeeded, failed, pending, processing, canceled

  // Metadata
  description String?
  receiptUrl  String? @db.VarChar(500)
  invoicePdf  String? @db.VarChar(500)

  // Failure tracking
  failureCode    String?
  failureMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ════════════════════════════════════════════════════════════════════════════════
// EXPORT REPORTS SYSTEM
// PDF, CSV, and Excel report generation with async processing
// ════════════════════════════════════════════════════════════════════════════════

/// Report type categories
enum ReportType {
  BATCH_TRACEABILITY
  PRODUCER_SUMMARY
  AUDIT_LOG
  INVENTORY
  ANALYTICS
  COMPLIANCE
  EVENTS_TIMELINE
}

/// Report output formats
enum ReportFormat {
  PDF
  CSV
  XLSX
}

/// Report generation status
enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

/// Generated report record
model Report {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report details
  type      ReportType
  format    ReportFormat
  status    ReportStatus @default(PENDING)
  name      String?   @db.VarChar(255)

  // Storage
  fileUrl   String?   @db.VarChar(500)
  fileKey   String?   @db.VarChar(255)
  fileSize  Int?      // Size in bytes

  // Generation parameters
  filters   Json?     // Filters applied (date range, producer, status, etc.)

  // Processing info
  error       String?   @db.Text
  jobId       String?   @db.VarChar(100)
  processingTime Int?   // Duration in milliseconds

  // Timestamps
  createdAt   DateTime @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Auto-delete after expiration (30 days default)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("reports")
}

// ════════════════════════════════════════════════════════════════════════════════
// CASH FLOW BRIDGE - DYNAMIC ADVANCE SYSTEM
// Production-Ready Financial Module for Agricultural Financing
// Enables instant advances (70-85%) against blockchain-confirmed orders
// ════════════════════════════════════════════════════════════════════════════════

/// Risk tier classification for credit scoring
enum RiskTier {
  A      // Low risk: 90-100 score, excellent history
  B      // Medium risk: 70-89 score, good history
  C      // High risk: <70 score or new farmer
}

/// Liquidity pool operational status
enum PoolStatus {
  ACTIVE        // Operating normally
  PAUSED        // Temporarily not issuing new advances
  CLOSED        // No new advances, winding down
  LIQUIDATING   // In process of returning capital
}

/// Investor type classification
enum InvestorType {
  INDIVIDUAL    // Individual person
  INSTITUTION   // Bank, VC, investment firm
  FUND          // Dedicated investment fund
}

/// Investor participation status
enum InvestorStatus {
  ACTIVE        // Active investor
  SUSPENDED     // Temporarily suspended
  WITHDRAWN     // Withdrawn from pool
  PENDING_KYC   // Awaiting KYC approval
}

/// Pool transaction types for capital movements
enum PoolTransactionType {
  CAPITAL_DEPOSIT
  CAPITAL_WITHDRAWAL
  ADVANCE_DISBURSEMENT
  ADVANCE_REPAYMENT
  FEE_COLLECTION
  INTEREST_DISTRIBUTION
  PENALTY_FEE
  ADJUSTMENT
  RESERVE_ALLOCATION
}

/// Advance contract lifecycle status
enum AdvanceStatus {
  // Pre-disbursement
  PENDING_APPROVAL      // Farmer requested, awaiting underwriting
  UNDER_REVIEW          // Manual review in progress
  APPROVED              // Approved, awaiting disbursement
  REJECTED              // Request rejected

  // Active
  DISBURSED             // Money sent to farmer
  ACTIVE                // Order in progress
  DELIVERY_IN_PROGRESS  // Shipment started
  DELIVERY_CONFIRMED    // Blockchain confirmed delivery

  // Repayment
  PARTIALLY_REPAID      // Partial repayment received
  COMPLETED             // Fully repaid, contract closed

  // Problem states
  OVERDUE               // Past due date
  DEFAULT_WARNING       // 7 days overdue
  DEFAULTED             // 30+ days overdue
  IN_COLLECTIONS        // Sent to collections

  // Other
  CANCELLED             // Cancelled before disbursement
  REFUNDED              // Refunded to farmer
  DISPUTED              // Under dispute resolution
}

/// Blockchain deployment status
enum BlockchainStatus {
  NOT_DEPLOYED
  DEPLOYING
  DEPLOYED
  VERIFIED
  FAILED
}

/// Transaction types for advance contracts
enum AdvanceTransactionType {
  ADVANCE_DISBURSEMENT  // Initial advance to farmer
  PARTIAL_REPAYMENT     // Partial repayment from buyer
  FINAL_REPAYMENT       // Final repayment
  FEE_COLLECTION        // Platform fee deduction
  INTEREST_ACCRUAL      // Interest calculation
  REFUND                // Refund to farmer
  PENALTY               // Late payment penalty
  ADJUSTMENT            // Manual adjustment
  REVERSAL              // Transaction reversal
}

/// Payment method types
enum PaymentMethod {
  STRIPE          // Stripe transfers
  OPENPAY         // Openpay (Mexico)
  BANK_TRANSFER   // Direct bank transfer
  SPEI            // SPEI (Mexico interbank)
  CRYPTO          // Cryptocurrency
  CASH            // Cash deposit
}

/// Payment processing status
enum PaymentStatus {
  PENDING       // Queued for processing
  PROCESSING    // In progress
  COMPLETED     // Successfully completed
  FAILED        // Failed permanently
  REFUNDED      // Refunded to sender
  CANCELLED     // Cancelled before processing
  EXPIRED       // Authorization expired
}

/// Credit score trend direction
enum ScoreTrend {
  IMPROVING     // Score increasing
  STABLE        // No significant change
  DECLINING     // Score decreasing
}

/// Advance approval method
enum ApprovalMethod {
  MANUAL        // Human approved
  AUTOMATIC     // Auto-approved by algorithm
  SEMI_AUTO     // Algorithm suggested, human confirmed
}

/// Document types for advances
enum AdvanceDocumentType {
  CONTRACT              // Advance contract PDF
  INVOICE               // Invoice from farmer
  PROOF_OF_DELIVERY     // Delivery confirmation
  QUALITY_CERTIFICATE   // Quality inspection report
  BANK_STATEMENT        // Bank statement
  ID_DOCUMENT           // Government ID
  TAX_DOCUMENT          // Tax filing (RFC)
  INSURANCE_POLICY      // Crop insurance
  OTHER                 // Other document
}

/// Order model for advance eligibility
model Order {
  id                  String   @id @default(uuid())
  producerId          String
  producer            Producer @relation(fields: [producerId], references: [id])
  buyerId             String

  // Order details
  orderNumber         String   @unique
  productType         String
  quantity            Decimal  @db.Decimal(12, 2)
  unitPrice           Decimal  @db.Decimal(10, 2)
  totalAmount         Decimal  @db.Decimal(15, 2)
  currency            String   @default("MXN") @db.VarChar(3)

  // Timeline
  orderDate           DateTime @default(now())
  expectedDeliveryDate DateTime
  actualDeliveryDate  DateTime?

  // Status
  status              String   @default("PENDING")
  blockchainHash      String?

  // Cash Flow Bridge
  advanceEligible     Boolean  @default(false)
  advanceRequested    Boolean  @default(false)
  advanceRequestedAt  DateTime?

  // Relations
  advanceContract     AdvanceContract?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([producerId])
  @@index([buyerId])
  @@index([status])
  @@index([advanceEligible])
  @@map("orders")
}

/// Liquidity Pool - Capital pools from investors funding advances
model LiquidityPool {
  id                String   @id @default(uuid())
  name              String   @db.VarChar(100)
  description       String?  @db.Text

  // Capital Management (Decimal for precision)
  totalCapital      Decimal  @db.Decimal(18, 2) // Total committed capital
  availableCapital  Decimal  @db.Decimal(18, 2) // Currently available
  deployedCapital   Decimal  @db.Decimal(18, 2) // In active advances
  reservedCapital   Decimal  @db.Decimal(18, 2) @default(0) // Reserved for pending

  // Risk & Returns
  riskTier          RiskTier @default(B)
  targetReturnRate  Decimal  @db.Decimal(5, 2)  // Annual ROI target (e.g., 15.00%)
  actualReturnRate  Decimal  @db.Decimal(5, 2)  @default(0) // Calculated actual ROI

  // Performance Metrics (denormalized for quick access)
  totalAdvancesIssued    Int      @default(0)
  totalAdvancesCompleted Int      @default(0)
  totalAdvancesDefaulted Int      @default(0)
  totalAdvancesActive    Int      @default(0)
  defaultRate            Decimal  @db.Decimal(5, 4) @default(0) // %

  totalDisbursed         Decimal  @db.Decimal(18, 2) @default(0) // Lifetime
  totalRepaid            Decimal  @db.Decimal(18, 2) @default(0) // Lifetime
  totalFeesEarned        Decimal  @db.Decimal(18, 2) @default(0) // Lifetime

  // Operational Constraints
  status            PoolStatus @default(ACTIVE)
  minAdvanceAmount  Decimal    @db.Decimal(12, 2) @default(5000)
  maxAdvanceAmount  Decimal    @db.Decimal(12, 2) @default(500000)
  maxExposureLimit  Decimal    @db.Decimal(18, 2) // Max total deployed

  // Auto-Management
  autoRebalanceEnabled Boolean @default(true)
  minReserveRatio      Decimal @db.Decimal(5, 2) @default(15) // Keep 15% liquid

  // Currency
  currency          String   @default("USD") @db.VarChar(3)

  // Relationships
  advances          AdvanceContract[]
  investors         PoolInvestor[]
  transactions      PoolTransaction[]

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?  // Admin user ID

  @@index([status, riskTier])
  @@index([status, availableCapital])
  @@map("liquidity_pools")
}

/// Pool Investor - Individual or institutional investor in a pool
model PoolInvestor {
  id              String   @id @default(uuid())

  // Pool Reference
  poolId          String
  pool            LiquidityPool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  // Investor Info
  investorId      String   // User ID or external institution ID
  investorName    String   @db.VarChar(200)
  investorEmail   String   @db.VarChar(255)
  investorType    InvestorType @default(INDIVIDUAL)

  // Investment Capital
  committedCapital Decimal @db.Decimal(18, 2)
  deployedCapital  Decimal @db.Decimal(18, 2) @default(0)
  totalReturns     Decimal @db.Decimal(18, 2) @default(0)
  unrealizedGains  Decimal @db.Decimal(18, 2) @default(0)
  currentROI       Decimal @db.Decimal(5, 2)  @default(0) // %

  // Payment Details
  bankAccountId    String?  // For distributions
  taxId            String?  // For reporting (encrypted)

  // Status & Dates
  status          InvestorStatus @default(ACTIVE)
  joinedAt        DateTime @default(now())
  lastPayoutAt    DateTime?
  withdrawalRequestedAt DateTime?

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([poolId, investorId])
  @@index([investorId])
  @@index([status])
  @@map("pool_investors")
}

/// Pool Transaction - All capital movements within pools
model PoolTransaction {
  id              String   @id @default(uuid())

  poolId          String
  pool            LiquidityPool @relation(fields: [poolId], references: [id])

  type            PoolTransactionType
  amount          Decimal  @db.Decimal(18, 2)
  balanceBefore   Decimal  @db.Decimal(18, 2)
  balanceAfter    Decimal  @db.Decimal(18, 2)

  description     String   @db.Text
  metadata        Json?

  // Reference
  relatedAdvanceId String?
  relatedInvestorId String?

  createdAt       DateTime @default(now())

  @@index([poolId, createdAt])
  @@index([type])
  @@map("pool_transactions")
}

/// Advance Contract - Core entity for cash advances
model AdvanceContract {
  id                    String   @id @default(uuid())
  contractNumber        String   @unique // Human-readable: ACF-2025-00123

  // Order Reference
  orderId               String   @unique
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Parties
  farmerId              String
  farmer                Producer @relation("FarmerAdvances", fields: [farmerId], references: [id])
  buyerId               String

  // Liquidity Pool
  poolId                String
  pool                  LiquidityPool @relation(fields: [poolId], references: [id])

  // Financial Terms (ALL in Decimal for precision)
  currency              String   @default("MXN") @db.VarChar(3)
  orderAmount           Decimal  @db.Decimal(15, 2) // Total order value
  advancePercentage     Decimal  @db.Decimal(5, 2)  // e.g., 80.00%
  advanceAmount         Decimal  @db.Decimal(15, 2) // Amount advanced to farmer

  // Fees (transparent breakdown)
  farmerFeePercentage   Decimal  @db.Decimal(5, 2)  // e.g., 2.50%
  farmerFeeAmount       Decimal  @db.Decimal(12, 2)

  buyerFeePercentage    Decimal  @db.Decimal(5, 2)  // e.g., 1.50%
  buyerFeeAmount        Decimal  @db.Decimal(12, 2)

  implicitInterest      Decimal  @db.Decimal(12, 2) // Time-based interest
  platformFeeTotal      Decimal  @db.Decimal(12, 2) // Sum of all fees

  // Costs (for profitability tracking)
  costOfCapital         Decimal  @db.Decimal(12, 2) // Interest on borrowed capital
  operatingCosts        Decimal  @db.Decimal(12, 2) @default(100) // Fixed ops cost
  riskProvision         Decimal  @db.Decimal(12, 2) // Set aside for defaults

  // Calculated Profit
  totalRevenue          Decimal  @db.Decimal(12, 2) // platformFeeTotal
  grossProfit           Decimal  @db.Decimal(12, 2) // Revenue - costs
  profitMargin          Decimal  @db.Decimal(5, 2)  // %

  // Timeline
  requestedAt           DateTime @default(now())
  approvedAt            DateTime?
  disbursedAt           DateTime?
  expectedDeliveryDate  DateTime // From order
  actualDeliveryDate    DateTime?
  repaidAt              DateTime?
  dueDate               DateTime // Payment deadline
  daysOutstanding       Int      @default(0)

  // Status Tracking
  status                AdvanceStatus @default(PENDING_APPROVAL)
  substatus             String?  @db.VarChar(100)

  // Risk & Credit (snapshot at approval time)
  creditScoreId         String?
  creditScore           CreditScore? @relation(fields: [creditScoreId], references: [id])
  creditScoreValue      Decimal     @db.Decimal(5, 2) // Snapshot of score
  riskTier              RiskTier
  riskAssessmentScore   Decimal     @db.Decimal(5, 2) // 0-100

  // Fraud Detection
  fraudScore            Decimal?    @db.Decimal(5, 2) // 0-100
  fraudFlags            String[]    // Array of fraud indicators
  requiresManualReview  Boolean     @default(false)

  // Blockchain Integration
  smartContractAddress  String?     @db.VarChar(42)
  blockchainNetwork     String?     @default("polygon-mumbai")
  blockchainTxHash      String?     @db.VarChar(66)
  blockchainProofHash   String?     @db.VarChar(66)
  blockchainStatus      BlockchainStatus @default(NOT_DEPLOYED)

  // Repayment Tracking
  amountRepaid          Decimal     @db.Decimal(15, 2) @default(0)
  remainingBalance      Decimal     @db.Decimal(15, 2)
  repaymentSchedule     Json?

  // Payment Methods
  disbursementMethod    PaymentMethod @default(STRIPE)
  disbursementReference String?
  disbursementFee       Decimal?      @db.Decimal(12, 2)

  repaymentMethod       PaymentMethod?
  repaymentReference    String?

  // Collateral
  collateralType        String?
  collateralValue       Decimal?    @db.Decimal(15, 2)
  collateralDocuments   Json?

  // Relationships
  transactions          AdvanceTransaction[]
  statusHistory         AdvanceStatusHistory[]
  documents             AdvanceDocument[]

  // Approval & Compliance
  approvedBy            String?
  approvalMethod        ApprovalMethod @default(MANUAL)
  approvalNotes         String?     @db.Text
  rejectionReason       String?     @db.Text
  complianceChecks      Json?

  // Communication
  notificationsSent     Json?
  lastReminderSentAt    DateTime?

  // Internal Notes
  internalNotes         String?     @db.Text
  tags                  String[]

  // Soft Delete
  deletedAt             DateTime?
  deletedBy             String?

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([farmerId, status])
  @@index([buyerId, status])
  @@index([orderId])
  @@index([poolId, status])
  @@index([status, dueDate])
  @@index([status, createdAt])
  @@index([creditScoreId])
  @@index([contractNumber])
  @@map("advance_contracts")
}

/// Credit Score - Blockchain-verified credit scoring for farmers
model CreditScore {
  id                      String   @id @default(uuid())

  producerId              String   @unique
  producer                Producer @relation("ProducerCreditScore", fields: [producerId], references: [id])

  // Core Delivery Metrics
  totalOrdersCompleted    Int      @default(0)
  totalOrdersDefaulted    Int      @default(0)
  totalOrdersCancelled    Int      @default(0)
  deliverySuccessRate     Decimal  @db.Decimal(5, 2) @default(0) // %

  // Quality Metrics
  averageQualityScore     Decimal  @db.Decimal(5, 2) @default(0) // 0-100
  qualityConsistency      Decimal  @db.Decimal(5, 2) @default(0) // Std deviation
  recentQualityTrend      ScoreTrend @default(STABLE)

  // Timeliness
  averageDeliveryDelay    Int      @default(0) // Days
  onTimeDeliveryRate      Decimal  @db.Decimal(5, 2) @default(0) // %

  // Volume & Value
  totalVolumeDelivered    Decimal  @db.Decimal(18, 2) @default(0) // kg
  totalValueDelivered     Decimal  @db.Decimal(18, 2) @default(0) // USD
  avgOrderValue           Decimal  @db.Decimal(15, 2) @default(0)

  // Payment History (for advances)
  advancesCompleted       Int      @default(0)
  advancesDefaulted       Int      @default(0)
  advancesActive          Int      @default(0)
  advanceDefaultRate      Decimal  @db.Decimal(5, 4) @default(0) // %

  averageRepaymentDelay   Int      @default(0) // Days
  totalAmountBorrowed     Decimal  @db.Decimal(18, 2) @default(0)
  totalAmountRepaid       Decimal  @db.Decimal(18, 2) @default(0)

  // Account Age & Activity
  accountAgeDays          Int      @default(0)
  daysActive              Int      @default(0)
  activityFrequency       Decimal  @db.Decimal(5, 2) @default(0) // Orders/month

  // Calculated Composite Score (0-100)
  deliveryScore           Decimal  @db.Decimal(5, 2) @default(0)
  qualityScore            Decimal  @db.Decimal(5, 2) @default(0)
  paymentScore            Decimal  @db.Decimal(5, 2) @default(0)
  volumeScore             Decimal  @db.Decimal(5, 2) @default(0)
  blockchainScore         Decimal  @db.Decimal(5, 2) @default(0)

  overallScore            Decimal  @db.Decimal(5, 2) @default(0) // FINAL
  riskTier                RiskTier @default(C)

  // Credit Limits
  maxAdvanceAmount        Decimal  @db.Decimal(15, 2) @default(0)
  currentUtilization      Decimal  @db.Decimal(15, 2) @default(0)
  availableCredit         Decimal  @db.Decimal(15, 2) @default(0)
  utilizationRate         Decimal  @db.Decimal(5, 2) @default(0) // %

  // Score Changes
  scoreChange7Days        Decimal  @db.Decimal(5, 2) @default(0)
  scoreChange30Days       Decimal  @db.Decimal(5, 2) @default(0)
  scoreChange90Days       Decimal  @db.Decimal(5, 2) @default(0)
  trend                   ScoreTrend @default(STABLE)

  // Blockchain References
  blockchainVerifications String[] // Array of tx hashes
  lastBlockchainSync      DateTime?

  // Model Metadata
  modelVersion            String   @default("1.0")
  lastCalculatedAt        DateTime @default(now())
  calculatedBy            String?  @default("SYSTEM")
  calculationDuration     Int?     // Milliseconds

  // Flags
  isManualOverride        Boolean  @default(false)
  manualScore             Decimal? @db.Decimal(5, 2)
  overrideReason          String?  @db.Text
  isUnderReview           Boolean  @default(false)

  // Relationships
  advances                AdvanceContract[]
  scoreHistory            CreditScoreHistory[]

  // Audit
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([overallScore])
  @@index([riskTier])
  @@index([producerId, overallScore])
  @@map("credit_scores")
}

/// Credit Score History - Track score changes for analytics and audit
model CreditScoreHistory {
  id              String      @id @default(uuid())

  creditScoreId   String
  creditScore     CreditScore @relation(fields: [creditScoreId], references: [id], onDelete: Cascade)

  // Snapshot values
  overallScore    Decimal     @db.Decimal(5, 2)
  riskTier        RiskTier
  deliveryScore   Decimal     @db.Decimal(5, 2)
  qualityScore    Decimal     @db.Decimal(5, 2)
  paymentScore    Decimal     @db.Decimal(5, 2)

  // Change metadata
  changeAmount    Decimal     @db.Decimal(5, 2)
  changeReason    String      @db.VarChar(500)
  triggerEvent    String?     @db.VarChar(200)

  createdAt       DateTime    @default(now())

  @@index([creditScoreId, createdAt])
  @@index([createdAt])
  @@map("credit_score_history")
}

/// Advance Transaction - Individual money movements
model AdvanceTransaction {
  id                String          @id @default(uuid())
  transactionNumber String          @unique // TXN-2025-123456

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  // Transaction Details
  type              AdvanceTransactionType
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @default("MXN") @db.VarChar(3)

  // Exchange Rate
  exchangeRate      Decimal?        @db.Decimal(10, 6)
  amountInUSD       Decimal?        @db.Decimal(15, 2)

  // Payment Provider Details
  paymentMethod     PaymentMethod
  paymentProvider   String          @db.VarChar(50)
  paymentReference  String
  paymentStatus     PaymentStatus   @default(PENDING)
  providerFee       Decimal?        @db.Decimal(12, 2)

  // Parties
  fromUserId        String?
  fromAccountId     String?
  toUserId          String?
  toAccountId       String?

  // Balance Tracking
  balanceBefore     Decimal         @db.Decimal(15, 2)
  balanceAfter      Decimal         @db.Decimal(15, 2)

  // Metadata
  description       String          @db.Text
  metadata          Json?
  internalNotes     String?         @db.Text

  // Reconciliation
  isReconciled      Boolean         @default(false)
  reconciledAt      DateTime?
  reconciledBy      String?

  // Timestamps
  scheduledFor      DateTime?
  processedAt       DateTime?
  settledAt         DateTime?
  failedAt          DateTime?
  failureReason     String?         @db.Text
  retryCount        Int             @default(0)

  // Idempotency
  idempotencyKey    String?         @unique

  createdAt         DateTime        @default(now())

  @@index([advanceId, type])
  @@index([advanceId, createdAt])
  @@index([paymentStatus])
  @@index([type, createdAt])
  @@index([transactionNumber])
  @@map("advance_transactions")
}

/// Advance Status History - Audit trail of status changes
model AdvanceStatusHistory {
  id                String          @id @default(uuid())

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  fromStatus        AdvanceStatus?
  toStatus          AdvanceStatus

  // Change metadata
  changedBy         String?
  changedByName     String?         @db.VarChar(200)
  changedByRole     String?         @db.VarChar(50)

  reason            String?         @db.Text
  automaticChange   Boolean         @default(false)
  metadata          Json?

  // IP and device (for security audit)
  ipAddress         String?         @db.VarChar(45)
  userAgent         String?         @db.Text

  createdAt         DateTime        @default(now())

  @@index([advanceId, createdAt])
  @@index([toStatus, createdAt])
  @@map("advance_status_history")
}

/// Advance Document - Document storage references
model AdvanceDocument {
  id                String          @id @default(uuid())

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  documentType      AdvanceDocumentType
  fileName          String          @db.VarChar(500)
  fileSize          Int
  mimeType          String          @db.VarChar(100)

  // Storage
  storageProvider   String          @default("S3")
  storageKey        String          @db.VarChar(1000)
  storageUrl        String?         @db.Text
  urlExpiresAt      DateTime?

  // Security
  isEncrypted       Boolean         @default(false)
  encryptionKeyRef  String?
  checksumSHA256    String?         @db.VarChar(64)

  // Metadata
  uploadedBy        String
  uploadedByName    String          @db.VarChar(200)
  description       String?         @db.Text
  metadata          Json?

  // Virus scan
  isScanned         Boolean         @default(false)
  scanResult        String?
  scannedAt         DateTime?

  createdAt         DateTime        @default(now())
  deletedAt         DateTime?

  @@index([advanceId, documentType])
  @@index([documentType, createdAt])
  @@map("advance_documents")
}
