generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PRODUCER
  CERTIFIER
  BUYER
  QA                    // Quality Assurance inspector
  EXPORTER              // Export customs handler
  DRIVER                // Transit driver
  EXPORT_COMPANY_ADMIN  // Export company administrator (certificate review/approval)
}

enum BatchStatus {
  REGISTERED
  IN_TRANSIT
  ARRIVED
  DELIVERED
  REJECTED
}

enum EventType {
  HARVEST
  PROCESSING
  QUALITY_INSPECTION
  PACKAGING
  TRANSPORT_START
  TRANSPORT_ARRIVAL
  CUSTOMS_CLEARANCE
  DELIVERY
}

enum CertificationType {
  GLOBALGAP
  ORGANIC_USDA
  ORGANIC_EU
  RAINFOREST_ALLIANCE
  FAIR_TRADE
  SENASICA
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String?  // Nullable for OAuth-only users
  firstName     String
  lastName      String
  role          UserRole
  walletAddress String?  @unique
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?

  // Two-Factor Authentication (2FA)
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecret    String?  // Encrypted TOTP secret
  backupCodes        String[] @default([]) // Hashed backup codes
  twoFactorEnabledAt DateTime?

  // OAuth providers linked to this account
  oauthProviders OAuthProvider[]

  producer      Producer?
  createdEvents TraceabilityEvent[]

  // Notification system relations
  notifications           Notification[]
  deviceTokens            DeviceToken[]
  notificationPreferences NotificationPreference?

  // Payment and subscription
  subscription Subscription?

  // Export reports
  reports Report[]

  // Export company admin relation (organic certification pivot)
  exportCompanyAdminOf ExportCompany? @relation("ExportCompanyAdmins", fields: [exportCompanyAdminId], references: [id])
  exportCompanyAdminId String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([walletAddress])
  @@index([exportCompanyAdminId])
  @@map("users")
}

model Producer {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessName  String
  rfc           String   @unique
  state         String
  municipality  String
  address       String?
  latitude      Decimal  @db.Decimal(10, 6)
  longitude     Decimal  @db.Decimal(10, 6)
  
  totalHectares Decimal? @db.Decimal(10, 2)
  cropTypes     String[]
  
  isWhitelisted Boolean  @default(false)
  whitelistedAt DateTime?
  whitelistedBy String?
  
  batches          Batch[]
  certifications   Certification[]

  // Cash Flow Bridge Relations
  orders           Order[]
  advances         AdvanceContract[]   @relation("FarmerAdvances")
  creditScore      CreditScore?        @relation("ProducerCreditScore")

  // Traceability 2.0 - Satellite Imagery
  fields           Field[]

  // Export company relation (organic certification pivot)
  exportCompanyId      String?
  exportCompany        ExportCompany?     @relation("ExportCompanyFarmers", fields: [exportCompanyId], references: [id])

  // Organic certification relations
  organicFields        OrganicField[]
  organicCertificates  OrganicCertificate[] @relation("FarmerOrganicCertificates")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([rfc])
  @@index([isWhitelisted])
  @@index([state, municipality])
  @@index([exportCompanyId])
  @@map("producers")
}

model Certification {
  id                String            @id @default(uuid())
  producerId        String
  producer          Producer          @relation(fields: [producerId], references: [id], onDelete: Cascade)
  
  type              CertificationType
  certifier         String
  certificateNumber String            @unique
  ipfsHash          String?
  
  issuedAt          DateTime
  expiresAt         DateTime
  isActive          Boolean           @default(true)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([producerId, type])
  @@index([certificateNumber])
  @@index([expiresAt])
  @@map("certifications")
}

enum Variety {
  HASS
  BERRIES
}

model Batch {
  id              String      @id @default(uuid())
  producerId      String
  producer        Producer    @relation(fields: [producerId], references: [id])

  variety         Variety
  origin          String
  weightKg        Decimal     @db.Decimal(10, 2)
  harvestDate     DateTime

  blockchainHash  String

  status          BatchStatus @default(REGISTERED)

  events          TraceabilityEvent[]

  // Traceability 2.0 relations
  verificationStages   VerificationStage[]
  qualityCertificates  QualityCertificate[]
  transitSessions      TransitSession[]
  temperatureReadings  TemperatureReading[]
  nfcSeals             NfcSeal[]

  // Traceability 2.0 - Stage finalization
  stagesFinalized     Boolean   @default(false)
  stagesFinalizedHash String?
  stagesFinalizedTxId String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([producerId])
  @@index([status])
  @@index([harvestDate])
  @@map("batches")
}

model TraceabilityEvent {
  id                String    @id @default(uuid())
  batchId           String
  batch             Batch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  eventType         EventType
  timestamp         DateTime  @default(now())
  
  latitude          Decimal   @db.Decimal(10, 6)
  longitude         Decimal   @db.Decimal(10, 6)
  locationName      String?
  
  temperature       Decimal?  @db.Decimal(5, 2)
  humidity          Decimal?  @db.Decimal(5, 2)
  notes             String?   @db.Text
  
  ipfsHash          String?
  photos            String[]
  
  blockchainTxHash  String?   @unique
  blockchainEventId String?   @unique
  isVerified        Boolean   @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  
  signedByBiometric Boolean   @default(false)
  signatureHash     String?
  
  createdById       String
  createdBy         User      @relation(fields: [createdById], references: [id])
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([batchId])
  @@index([eventType])
  @@index([timestamp])
  @@index([blockchainTxHash])
  @@map("traceability_events")
}

model RefreshToken {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ════════════════════════════════════════════════════════════════════════════════
// OAUTH PROVIDER SCHEMA
// Stores linked OAuth providers (Google, GitHub) for each user
// ════════════════════════════════════════════════════════════════════════════════

/// OAuth provider types
enum OAuthProviderType {
  GOOGLE
  GITHUB
}

/// OAuth provider linked to a user account
model OAuthProvider {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider    OAuthProviderType
  providerId  String            // Provider's unique user ID
  email       String?           // Email from OAuth provider (may differ from user email)

  // Provider-specific data
  accessToken  String?          // Encrypted OAuth access token (for API calls)
  refreshToken String?          // Encrypted OAuth refresh token
  expiresAt    DateTime?        // Token expiration

  // Profile data from provider
  displayName  String?
  avatarUrl    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_providers")
}

// ════════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM SCHEMA
// Enterprise-grade multi-channel notification infrastructure
// Supports: Push (FCM/APNs), Email (SendGrid), SMS (Twilio)
// ════════════════════════════════════════════════════════════════════════════════

/// Notification type categories for the agricultural platform
enum NotificationType {
  BATCH_CREATED
  BATCH_UPDATED
  BATCH_VERIFIED
  BATCH_STATUS_CHANGED
  CERTIFICATE_READY
  CERTIFICATE_DOWNLOADED
  CERTIFICATE_EXPIRING
  SENSOR_ALERT
  SENSOR_WARNING
  ORDER_CREATED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PRODUCER_WHITELISTED
  PRODUCER_SUSPENDED
  SYSTEM_ANNOUNCEMENT
  ACCOUNT_VERIFICATION
  PASSWORD_RESET
  WELCOME
  CUSTOM
}

/// Delivery channels for notifications
enum NotificationChannel {
  PUSH      // FCM for Android, APNs for iOS
  EMAIL     // SendGrid transactional emails
  SMS       // Twilio SMS messages
  WHATSAPP  // Twilio WhatsApp Business API
  IN_APP    // Stored in database for in-app notification center
  WEBHOOK   // HTTP callback to external systems
}

/// Notification delivery status tracking
enum NotificationStatus {
  PENDING     // Queued, not yet processed
  QUEUED      // Added to Bull queue for processing
  SENT        // Sent to provider (FCM/APNs/SendGrid/Twilio)
  DELIVERED   // Confirmed delivered by provider callback
  READ        // User opened/read the notification
  CLICKED     // User clicked/interacted with notification
  FAILED      // Delivery failed after all retries
  EXPIRED     // TTL expired before delivery
  CANCELLED   // Cancelled before sending
}

/// Notification priority levels
enum NotificationPriority {
  LOW       // Marketing, announcements (can be delayed)
  NORMAL    // Standard notifications (batch updates)
  HIGH      // Important updates (certificates, orders)
  CRITICAL  // Urgent alerts (sensor alerts, security)
}

/// Mobile platform types for device tokens
enum Platform {
  IOS
  ANDROID
  WEB
}

/// Delivery attempt status for logs
enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRY
}

/// Main notification record - tracks every notification sent through the system
model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type        NotificationType
  title       String   @db.VarChar(255)
  body        String   @db.Text
  data        Json?    // Custom payload for deep linking, e.g., {"batchId": "xxx", "deepLink": "/batches/xxx"}
  imageUrl    String?  @db.VarChar(500)

  // Channels - which delivery methods to use
  channels    NotificationChannel[]

  // Status tracking
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  clickedAt   DateTime?
  failedAt    DateTime?
  errorMessage String? @db.Text

  // Metadata
  priority    NotificationPriority @default(NORMAL)
  expiresAt   DateTime?  // TTL - notification expires after this time
  retryCount  Int        @default(0)
  maxRetries  Int        @default(3)

  // Delivery logs for each channel
  deliveryLogs NotificationDeliveryLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Performance indexes
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, status])
  @@index([status, createdAt])
  @@index([type, createdAt])
  @@index([priority, status])
  @@map("notifications")
}

/// Device tokens for push notifications (iOS & Android)
model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform  Platform
  token     String   @unique @db.VarChar(500)  // FCM token or APNs device token

  // Device metadata for debugging and analytics
  deviceInfo Json?   // OS version, device model, app version, etc.

  // Status
  active    Boolean  @default(true)  // Set to false when token becomes invalid
  lastUsedAt DateTime @default(now())

  // FCM topic subscriptions
  topics    String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, active])
  @@index([platform, active])
  @@index([token])
  @@map("device_tokens")
}

/// Notification delivery logs - tracks each delivery attempt per channel
model NotificationDeliveryLog {
  id             String   @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  channel        NotificationChannel
  status         DeliveryStatus

  // Provider response data
  providerId     String?  @db.VarChar(255)  // FCM message ID, APNs ID, SendGrid ID, Twilio SID
  providerError  String?  @db.Text
  providerResponse Json?  // Full provider response for debugging

  // Timing metrics
  attemptedAt    DateTime @default(now())
  deliveredAt    DateTime?
  latencyMs      Int?     // Time from attempt to delivery confirmation

  // Retry tracking
  attempt        Int      @default(1)

  createdAt      DateTime @default(now())

  @@index([notificationId])
  @@index([channel, status])
  @@index([attemptedAt])
  @@map("notification_delivery_logs")
}

/// Notification templates - reusable notification content with variable substitution
model NotificationTemplate {
  id          String   @id @default(uuid())

  name        String   @unique @db.VarChar(100)  // e.g., "batch-created", "sensor-alert"
  type        NotificationType

  // Templates support Handlebars-style variables like {{batchId}}, {{producerName}}
  titleTemplate String  @db.VarChar(255)
  bodyTemplate  String  @db.Text

  // Email-specific templates (optional)
  emailSubject  String? @db.VarChar(255)
  emailHtml     String? @db.Text  // Full HTML email template

  // SMS-specific (optional, should be < 160 chars)
  smsTemplate   String? @db.VarChar(500)

  // Default channels and priority
  defaultChannels NotificationChannel[] @default([PUSH, EMAIL])
  defaultPriority NotificationPriority @default(NORMAL)

  // Template status
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([active])
  @@map("notification_templates")
}

/// User notification preferences - controls what notifications users receive
model NotificationPreference {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  pushEnabled   Boolean @default(true)
  emailEnabled  Boolean @default(true)
  smsEnabled    Boolean @default(false)  // SMS is opt-in due to cost
  whatsappEnabled Boolean @default(false)

  // Type-specific preferences (JSON map of NotificationType -> boolean)
  typePreferences Json @default("{}")

  // Quiet hours (no notifications during these times)
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? @db.VarChar(5)  // HH:MM format, e.g., "22:00"
  quietHoursEnd     String? @db.VarChar(5)  // HH:MM format, e.g., "08:00"
  timezone          String  @default("America/Mexico_City")

  // Contact info for SMS/WhatsApp
  phoneNumber       String? @db.VarChar(20)  // E.164 format: +521234567890
  phoneVerified     Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notification_preferences")
}

// ════════════════════════════════════════════════════════════════════════════════
// AUDIT LOGGING SYSTEM
// Enterprise-grade audit trail for compliance (FSMA, SENASICA, EU Regulations)
// 7-year retention policy for traceability requirements
// ════════════════════════════════════════════════════════════════════════════════

/// Audit action types for tracking all system operations
enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_RESET
  PASSWORD_CHANGE
  TOKEN_REFRESH

  // CRUD Operations
  CREATE
  READ
  UPDATE
  DELETE

  // Business Actions
  VERIFY_PRODUCER
  WHITELIST_PRODUCER
  SUSPEND_PRODUCER
  GENERATE_QR
  UPDATE_BATCH_STATUS
  REGISTER_EVENT
  VERIFY_EVENT
  ADD_CERTIFICATION

  // Admin Actions
  ADMIN_ACTION
  EXPORT_DATA
  BULK_OPERATION

  // Security Events
  ACCESS_DENIED
  RATE_LIMIT_EXCEEDED
  INVALID_TOKEN
  SUSPICIOUS_ACTIVITY
}

/// Audit log entry - immutable record of all system actions
model AuditLog {
  id            String      @id @default(uuid())
  userId        String?     // Can be null for system actions or unauthenticated requests
  action        AuditAction
  resource      String      // Resource type: User, Producer, Batch, Event, etc.
  resourceId    String?     // ID of the affected resource
  details       Json?       // Additional context (changes made, before/after values)
  ipAddress     String?     @db.VarChar(45) // IPv6 compatible
  userAgent     String?     @db.VarChar(500)
  correlationId String?     @db.VarChar(100) // For request tracking across services
  requestId     String?     @db.VarChar(100) // Unique request identifier

  // Result tracking
  success       Boolean     @default(true)
  errorMessage  String?     @db.Text

  // Performance metrics
  durationMs    Int?        // Request duration in milliseconds

  timestamp     DateTime    @default(now())

  // Indexes for efficient querying
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([timestamp])
  @@index([correlationId])
  @@index([success])
  @@index([userId, timestamp])
  @@index([resource, action, timestamp])
  @@map("audit_logs")
}

// ════════════════════════════════════════════════════════════════════════════════
// STRIPE PAYMENT INTEGRATION
// Subscription billing, one-time payments, and usage-based billing
// ════════════════════════════════════════════════════════════════════════════════

/// Subscription tier levels for the platform
enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

/// Subscription status tracking
enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
  PAUSED
}

/// User subscription record
model Subscription {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe identifiers
  stripeCustomerId     String  @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Subscription details
  tier        SubscriptionTier   @default(FREE)
  status      SubscriptionStatus @default(ACTIVE)

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialEnd           DateTime?

  // Usage tracking for current period
  batchesUsed     Int @default(0)
  batchesLimit    Int @default(10)
  apiCallsUsed    Int @default(0)
  apiCallsLimit   Int @default(100)
  storageUsedMb   Int @default(0)
  storageLimitMb  Int @default(100)

  // Payment history
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

/// Payment record for invoices and one-time payments
model Payment {
  id             String   @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Stripe identifiers
  stripePaymentIntentId String  @unique
  stripeInvoiceId       String?

  // Payment details
  amount      Int    // Amount in cents
  currency    String @default("usd")
  status      String // succeeded, failed, pending, processing, canceled

  // Metadata
  description String?
  receiptUrl  String? @db.VarChar(500)
  invoicePdf  String? @db.VarChar(500)

  // Failure tracking
  failureCode    String?
  failureMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ════════════════════════════════════════════════════════════════════════════════
// EXPORT REPORTS SYSTEM
// PDF, CSV, and Excel report generation with async processing
// ════════════════════════════════════════════════════════════════════════════════

/// Report type categories
enum ReportType {
  BATCH_TRACEABILITY
  PRODUCER_SUMMARY
  AUDIT_LOG
  INVENTORY
  ANALYTICS
  COMPLIANCE
  EVENTS_TIMELINE
}

/// Report output formats
enum ReportFormat {
  PDF
  CSV
  XLSX
}

/// Report generation status
enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

/// Generated report record
model Report {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report details
  type      ReportType
  format    ReportFormat
  status    ReportStatus @default(PENDING)
  name      String?   @db.VarChar(255)

  // Storage
  fileUrl   String?   @db.VarChar(500)
  fileKey   String?   @db.VarChar(255)
  fileSize  Int?      // Size in bytes

  // Generation parameters
  filters   Json?     // Filters applied (date range, producer, status, etc.)

  // Processing info
  error       String?   @db.Text
  jobId       String?   @db.VarChar(100)
  processingTime Int?   // Duration in milliseconds

  // Timestamps
  createdAt   DateTime @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Auto-delete after expiration (30 days default)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("reports")
}

// ════════════════════════════════════════════════════════════════════════════════
// CASH FLOW BRIDGE - DYNAMIC ADVANCE SYSTEM
// Production-Ready Financial Module for Agricultural Financing
// Enables instant advances (70-85%) against blockchain-confirmed orders
// ════════════════════════════════════════════════════════════════════════════════

/// Risk tier classification for credit scoring
enum RiskTier {
  A      // Low risk: 90-100 score, excellent history
  B      // Medium risk: 70-89 score, good history
  C      // High risk: <70 score or new farmer
}

/// Liquidity pool operational status
enum PoolStatus {
  ACTIVE        // Operating normally
  PAUSED        // Temporarily not issuing new advances
  CLOSED        // No new advances, winding down
  LIQUIDATING   // In process of returning capital
}

/// Investor type classification
enum InvestorType {
  INDIVIDUAL    // Individual person
  INSTITUTION   // Bank, VC, investment firm
  FUND          // Dedicated investment fund
}

/// Investor participation status
enum InvestorStatus {
  ACTIVE        // Active investor
  SUSPENDED     // Temporarily suspended
  WITHDRAWN     // Withdrawn from pool
  PENDING_KYC   // Awaiting KYC approval
}

/// Pool transaction types for capital movements
enum PoolTransactionType {
  CAPITAL_DEPOSIT
  CAPITAL_WITHDRAWAL
  ADVANCE_DISBURSEMENT
  ADVANCE_REPAYMENT
  FEE_COLLECTION
  INTEREST_DISTRIBUTION
  PENALTY_FEE
  ADJUSTMENT
  RESERVE_ALLOCATION
}

/// Advance contract lifecycle status
enum AdvanceStatus {
  // Pre-disbursement
  PENDING_APPROVAL      // Farmer requested, awaiting underwriting
  UNDER_REVIEW          // Manual review in progress
  APPROVED              // Approved, awaiting disbursement
  REJECTED              // Request rejected

  // Active
  DISBURSED             // Money sent to farmer
  ACTIVE                // Order in progress
  DELIVERY_IN_PROGRESS  // Shipment started
  DELIVERY_CONFIRMED    // Blockchain confirmed delivery

  // Repayment
  PARTIALLY_REPAID      // Partial repayment received
  COMPLETED             // Fully repaid, contract closed

  // Problem states
  OVERDUE               // Past due date
  DEFAULT_WARNING       // 7 days overdue
  DEFAULTED             // 30+ days overdue
  IN_COLLECTIONS        // Sent to collections

  // Other
  CANCELLED             // Cancelled before disbursement
  REFUNDED              // Refunded to farmer
  DISPUTED              // Under dispute resolution
}

/// Blockchain deployment status
enum BlockchainStatus {
  NOT_DEPLOYED
  DEPLOYING
  DEPLOYED
  VERIFIED
  FAILED
}

/// Transaction types for advance contracts
enum AdvanceTransactionType {
  ADVANCE_DISBURSEMENT  // Initial advance to farmer
  PARTIAL_REPAYMENT     // Partial repayment from buyer
  FINAL_REPAYMENT       // Final repayment
  FEE_COLLECTION        // Platform fee deduction
  INTEREST_ACCRUAL      // Interest calculation
  REFUND                // Refund to farmer
  PENALTY               // Late payment penalty
  ADJUSTMENT            // Manual adjustment
  REVERSAL              // Transaction reversal
}

/// Payment method types
enum PaymentMethod {
  STRIPE          // Stripe transfers
  OPENPAY         // Openpay (Mexico)
  BANK_TRANSFER   // Direct bank transfer
  SPEI            // SPEI (Mexico interbank)
  CRYPTO          // Cryptocurrency
  CASH            // Cash deposit
}

/// Payment processing status
enum PaymentStatus {
  PENDING       // Queued for processing
  PROCESSING    // In progress
  COMPLETED     // Successfully completed
  FAILED        // Failed permanently
  REFUNDED      // Refunded to sender
  CANCELLED     // Cancelled before processing
  EXPIRED       // Authorization expired
}

/// Credit score trend direction
enum ScoreTrend {
  IMPROVING     // Score increasing
  STABLE        // No significant change
  DECLINING     // Score decreasing
}

/// Advance approval method
enum ApprovalMethod {
  MANUAL        // Human approved
  AUTOMATIC     // Auto-approved by algorithm
  SEMI_AUTO     // Algorithm suggested, human confirmed
}

/// Document types for advances
enum AdvanceDocumentType {
  CONTRACT              // Advance contract PDF
  INVOICE               // Invoice from farmer
  PROOF_OF_DELIVERY     // Delivery confirmation
  QUALITY_CERTIFICATE   // Quality inspection report
  BANK_STATEMENT        // Bank statement
  ID_DOCUMENT           // Government ID
  TAX_DOCUMENT          // Tax filing (RFC)
  INSURANCE_POLICY      // Crop insurance
  OTHER                 // Other document
}

/// Order model for advance eligibility
model Order {
  id                  String   @id @default(uuid())
  producerId          String
  producer            Producer @relation(fields: [producerId], references: [id])
  buyerId             String

  // Order details
  orderNumber         String   @unique
  productType         String
  quantity            Decimal  @db.Decimal(12, 2)
  unitPrice           Decimal  @db.Decimal(10, 2)
  totalAmount         Decimal  @db.Decimal(15, 2)
  currency            String   @default("MXN") @db.VarChar(3)

  // Timeline
  orderDate           DateTime @default(now())
  expectedDeliveryDate DateTime
  actualDeliveryDate  DateTime?

  // Status
  status              String   @default("PENDING")
  blockchainHash      String?

  // Cash Flow Bridge
  advanceEligible     Boolean  @default(false)
  advanceRequested    Boolean  @default(false)
  advanceRequestedAt  DateTime?

  // Relations
  advanceContract     AdvanceContract?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([producerId])
  @@index([buyerId])
  @@index([status])
  @@index([advanceEligible])
  @@map("orders")
}

/// Liquidity Pool - Capital pools from investors funding advances
model LiquidityPool {
  id                String   @id @default(uuid())
  name              String   @db.VarChar(100)
  description       String?  @db.Text

  // Capital Management (Decimal for precision)
  totalCapital      Decimal  @db.Decimal(18, 2) // Total committed capital
  availableCapital  Decimal  @db.Decimal(18, 2) // Currently available
  deployedCapital   Decimal  @db.Decimal(18, 2) // In active advances
  reservedCapital   Decimal  @db.Decimal(18, 2) @default(0) // Reserved for pending

  // Risk & Returns
  riskTier          RiskTier @default(B)
  targetReturnRate  Decimal  @db.Decimal(5, 2)  // Annual ROI target (e.g., 15.00%)
  actualReturnRate  Decimal  @db.Decimal(5, 2)  @default(0) // Calculated actual ROI

  // Performance Metrics (denormalized for quick access)
  totalAdvancesIssued    Int      @default(0)
  totalAdvancesCompleted Int      @default(0)
  totalAdvancesDefaulted Int      @default(0)
  totalAdvancesActive    Int      @default(0)
  defaultRate            Decimal  @db.Decimal(5, 4) @default(0) // %

  totalDisbursed         Decimal  @db.Decimal(18, 2) @default(0) // Lifetime
  totalRepaid            Decimal  @db.Decimal(18, 2) @default(0) // Lifetime
  totalFeesEarned        Decimal  @db.Decimal(18, 2) @default(0) // Lifetime

  // Operational Constraints
  status            PoolStatus @default(ACTIVE)
  minAdvanceAmount  Decimal    @db.Decimal(12, 2) @default(5000)
  maxAdvanceAmount  Decimal    @db.Decimal(12, 2) @default(500000)
  maxExposureLimit  Decimal    @db.Decimal(18, 2) // Max total deployed

  // Auto-Management
  autoRebalanceEnabled Boolean @default(true)
  minReserveRatio      Decimal @db.Decimal(5, 2) @default(15) // Keep 15% liquid

  // Currency
  currency          String   @default("USD") @db.VarChar(3)

  // Relationships
  advances          AdvanceContract[]
  investors         PoolInvestor[]
  transactions      PoolTransaction[]

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?  // Admin user ID

  @@index([status, riskTier])
  @@index([status, availableCapital])
  @@map("liquidity_pools")
}

/// Pool Investor - Individual or institutional investor in a pool
model PoolInvestor {
  id              String   @id @default(uuid())

  // Pool Reference
  poolId          String
  pool            LiquidityPool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  // Investor Info
  investorId      String   // User ID or external institution ID
  investorName    String   @db.VarChar(200)
  investorEmail   String   @db.VarChar(255)
  investorType    InvestorType @default(INDIVIDUAL)

  // Investment Capital
  committedCapital Decimal @db.Decimal(18, 2)
  deployedCapital  Decimal @db.Decimal(18, 2) @default(0)
  totalReturns     Decimal @db.Decimal(18, 2) @default(0)
  unrealizedGains  Decimal @db.Decimal(18, 2) @default(0)
  currentROI       Decimal @db.Decimal(5, 2)  @default(0) // %

  // Payment Details
  bankAccountId    String?  // For distributions
  taxId            String?  // For reporting (encrypted)

  // Status & Dates
  status          InvestorStatus @default(ACTIVE)
  joinedAt        DateTime @default(now())
  lastPayoutAt    DateTime?
  withdrawalRequestedAt DateTime?

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([poolId, investorId])
  @@index([investorId])
  @@index([status])
  @@map("pool_investors")
}

/// Pool Transaction - All capital movements within pools
model PoolTransaction {
  id              String   @id @default(uuid())

  poolId          String
  pool            LiquidityPool @relation(fields: [poolId], references: [id])

  type            PoolTransactionType
  amount          Decimal  @db.Decimal(18, 2)
  balanceBefore   Decimal  @db.Decimal(18, 2)
  balanceAfter    Decimal  @db.Decimal(18, 2)

  description     String   @db.Text
  metadata        Json?

  // Reference
  relatedAdvanceId String?
  relatedInvestorId String?

  createdAt       DateTime @default(now())

  @@index([poolId, createdAt])
  @@index([type])
  @@map("pool_transactions")
}

/// Advance Contract - Core entity for cash advances
model AdvanceContract {
  id                    String   @id @default(uuid())
  contractNumber        String   @unique // Human-readable: ACF-2025-00123

  // Order Reference
  orderId               String   @unique
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Parties
  farmerId              String
  farmer                Producer @relation("FarmerAdvances", fields: [farmerId], references: [id])
  buyerId               String

  // Liquidity Pool
  poolId                String
  pool                  LiquidityPool @relation(fields: [poolId], references: [id])

  // Financial Terms (ALL in Decimal for precision)
  currency              String   @default("MXN") @db.VarChar(3)
  orderAmount           Decimal  @db.Decimal(15, 2) // Total order value
  advancePercentage     Decimal  @db.Decimal(5, 2)  // e.g., 80.00%
  advanceAmount         Decimal  @db.Decimal(15, 2) // Amount advanced to farmer

  // Fees (transparent breakdown)
  farmerFeePercentage   Decimal  @db.Decimal(5, 2)  // e.g., 2.50%
  farmerFeeAmount       Decimal  @db.Decimal(12, 2)

  buyerFeePercentage    Decimal  @db.Decimal(5, 2)  // e.g., 1.50%
  buyerFeeAmount        Decimal  @db.Decimal(12, 2)

  implicitInterest      Decimal  @db.Decimal(12, 2) // Time-based interest
  platformFeeTotal      Decimal  @db.Decimal(12, 2) // Sum of all fees

  // Costs (for profitability tracking)
  costOfCapital         Decimal  @db.Decimal(12, 2) // Interest on borrowed capital
  operatingCosts        Decimal  @db.Decimal(12, 2) @default(100) // Fixed ops cost
  riskProvision         Decimal  @db.Decimal(12, 2) // Set aside for defaults

  // Calculated Profit
  totalRevenue          Decimal  @db.Decimal(12, 2) // platformFeeTotal
  grossProfit           Decimal  @db.Decimal(12, 2) // Revenue - costs
  profitMargin          Decimal  @db.Decimal(5, 2)  // %

  // Timeline
  requestedAt           DateTime @default(now())
  approvedAt            DateTime?
  disbursedAt           DateTime?
  expectedDeliveryDate  DateTime // From order
  actualDeliveryDate    DateTime?
  repaidAt              DateTime?
  dueDate               DateTime // Payment deadline
  daysOutstanding       Int      @default(0)

  // Status Tracking
  status                AdvanceStatus @default(PENDING_APPROVAL)
  substatus             String?  @db.VarChar(100)

  // Risk & Credit (snapshot at approval time)
  creditScoreId         String?
  creditScore           CreditScore? @relation(fields: [creditScoreId], references: [id])
  creditScoreValue      Decimal     @db.Decimal(5, 2) // Snapshot of score
  riskTier              RiskTier
  riskAssessmentScore   Decimal     @db.Decimal(5, 2) // 0-100

  // Fraud Detection
  fraudScore            Decimal?    @db.Decimal(5, 2) // 0-100
  fraudFlags            String[]    // Array of fraud indicators
  requiresManualReview  Boolean     @default(false)

  // Blockchain Integration
  smartContractAddress  String?     @db.VarChar(42)
  blockchainNetwork     String?     @default("polygon-mumbai")
  blockchainTxHash      String?     @db.VarChar(66)
  blockchainProofHash   String?     @db.VarChar(66)
  blockchainStatus      BlockchainStatus @default(NOT_DEPLOYED)

  // Repayment Tracking
  amountRepaid          Decimal     @db.Decimal(15, 2) @default(0)
  remainingBalance      Decimal     @db.Decimal(15, 2)
  repaymentSchedule     Json?

  // Payment Methods
  disbursementMethod    PaymentMethod @default(STRIPE)
  disbursementReference String?
  disbursementFee       Decimal?      @db.Decimal(12, 2)

  repaymentMethod       PaymentMethod?
  repaymentReference    String?

  // Collateral
  collateralType        String?
  collateralValue       Decimal?    @db.Decimal(15, 2)
  collateralDocuments   Json?

  // Relationships
  transactions          AdvanceTransaction[]
  statusHistory         AdvanceStatusHistory[]
  documents             AdvanceDocument[]

  // Approval & Compliance
  approvedBy            String?
  approvalMethod        ApprovalMethod @default(MANUAL)
  approvalNotes         String?     @db.Text
  rejectionReason       String?     @db.Text
  complianceChecks      Json?

  // Communication
  notificationsSent     Json?
  lastReminderSentAt    DateTime?

  // Internal Notes
  internalNotes         String?     @db.Text
  tags                  String[]

  // Soft Delete
  deletedAt             DateTime?
  deletedBy             String?

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([farmerId, status])
  @@index([buyerId, status])
  @@index([orderId])
  @@index([poolId, status])
  @@index([status, dueDate])
  @@index([status, createdAt])
  @@index([creditScoreId])
  @@index([contractNumber])
  @@map("advance_contracts")
}

/// Credit Score - Blockchain-verified credit scoring for farmers
model CreditScore {
  id                      String   @id @default(uuid())

  producerId              String   @unique
  producer                Producer @relation("ProducerCreditScore", fields: [producerId], references: [id])

  // Core Delivery Metrics
  totalOrdersCompleted    Int      @default(0)
  totalOrdersDefaulted    Int      @default(0)
  totalOrdersCancelled    Int      @default(0)
  deliverySuccessRate     Decimal  @db.Decimal(5, 2) @default(0) // %

  // Quality Metrics
  averageQualityScore     Decimal  @db.Decimal(5, 2) @default(0) // 0-100
  qualityConsistency      Decimal  @db.Decimal(5, 2) @default(0) // Std deviation
  recentQualityTrend      ScoreTrend @default(STABLE)

  // Timeliness
  averageDeliveryDelay    Int      @default(0) // Days
  onTimeDeliveryRate      Decimal  @db.Decimal(5, 2) @default(0) // %

  // Volume & Value
  totalVolumeDelivered    Decimal  @db.Decimal(18, 2) @default(0) // kg
  totalValueDelivered     Decimal  @db.Decimal(18, 2) @default(0) // USD
  avgOrderValue           Decimal  @db.Decimal(15, 2) @default(0)

  // Payment History (for advances)
  advancesCompleted       Int      @default(0)
  advancesDefaulted       Int      @default(0)
  advancesActive          Int      @default(0)
  advanceDefaultRate      Decimal  @db.Decimal(5, 4) @default(0) // %

  averageRepaymentDelay   Int      @default(0) // Days
  totalAmountBorrowed     Decimal  @db.Decimal(18, 2) @default(0)
  totalAmountRepaid       Decimal  @db.Decimal(18, 2) @default(0)

  // Account Age & Activity
  accountAgeDays          Int      @default(0)
  daysActive              Int      @default(0)
  activityFrequency       Decimal  @db.Decimal(5, 2) @default(0) // Orders/month

  // Calculated Composite Score (0-100)
  deliveryScore           Decimal  @db.Decimal(5, 2) @default(0)
  qualityScore            Decimal  @db.Decimal(5, 2) @default(0)
  paymentScore            Decimal  @db.Decimal(5, 2) @default(0)
  volumeScore             Decimal  @db.Decimal(5, 2) @default(0)
  blockchainScore         Decimal  @db.Decimal(5, 2) @default(0)

  overallScore            Decimal  @db.Decimal(5, 2) @default(0) // FINAL
  riskTier                RiskTier @default(C)

  // Credit Limits
  maxAdvanceAmount        Decimal  @db.Decimal(15, 2) @default(0)
  currentUtilization      Decimal  @db.Decimal(15, 2) @default(0)
  availableCredit         Decimal  @db.Decimal(15, 2) @default(0)
  utilizationRate         Decimal  @db.Decimal(5, 2) @default(0) // %

  // Score Changes
  scoreChange7Days        Decimal  @db.Decimal(5, 2) @default(0)
  scoreChange30Days       Decimal  @db.Decimal(5, 2) @default(0)
  scoreChange90Days       Decimal  @db.Decimal(5, 2) @default(0)
  trend                   ScoreTrend @default(STABLE)

  // Blockchain References
  blockchainVerifications String[] // Array of tx hashes
  lastBlockchainSync      DateTime?

  // Model Metadata
  modelVersion            String   @default("1.0")
  lastCalculatedAt        DateTime @default(now())
  calculatedBy            String?  @default("SYSTEM")
  calculationDuration     Int?     // Milliseconds

  // Flags
  isManualOverride        Boolean  @default(false)
  manualScore             Decimal? @db.Decimal(5, 2)
  overrideReason          String?  @db.Text
  isUnderReview           Boolean  @default(false)

  // Relationships
  advances                AdvanceContract[]
  scoreHistory            CreditScoreHistory[]

  // Audit
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([overallScore])
  @@index([riskTier])
  @@index([producerId, overallScore])
  @@map("credit_scores")
}

/// Credit Score History - Track score changes for analytics and audit
model CreditScoreHistory {
  id              String      @id @default(uuid())

  creditScoreId   String
  creditScore     CreditScore @relation(fields: [creditScoreId], references: [id], onDelete: Cascade)

  // Snapshot values
  overallScore    Decimal     @db.Decimal(5, 2)
  riskTier        RiskTier
  deliveryScore   Decimal     @db.Decimal(5, 2)
  qualityScore    Decimal     @db.Decimal(5, 2)
  paymentScore    Decimal     @db.Decimal(5, 2)

  // Change metadata
  changeAmount    Decimal     @db.Decimal(5, 2)
  changeReason    String      @db.VarChar(500)
  triggerEvent    String?     @db.VarChar(200)

  createdAt       DateTime    @default(now())

  @@index([creditScoreId, createdAt])
  @@index([createdAt])
  @@map("credit_score_history")
}

/// Advance Transaction - Individual money movements
model AdvanceTransaction {
  id                String          @id @default(uuid())
  transactionNumber String          @unique // TXN-2025-123456

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  // Transaction Details
  type              AdvanceTransactionType
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @default("MXN") @db.VarChar(3)

  // Exchange Rate
  exchangeRate      Decimal?        @db.Decimal(10, 6)
  amountInUSD       Decimal?        @db.Decimal(15, 2)

  // Payment Provider Details
  paymentMethod     PaymentMethod
  paymentProvider   String          @db.VarChar(50)
  paymentReference  String
  paymentStatus     PaymentStatus   @default(PENDING)
  providerFee       Decimal?        @db.Decimal(12, 2)

  // Parties
  fromUserId        String?
  fromAccountId     String?
  toUserId          String?
  toAccountId       String?

  // Balance Tracking
  balanceBefore     Decimal         @db.Decimal(15, 2)
  balanceAfter      Decimal         @db.Decimal(15, 2)

  // Metadata
  description       String          @db.Text
  metadata          Json?
  internalNotes     String?         @db.Text

  // Reconciliation
  isReconciled      Boolean         @default(false)
  reconciledAt      DateTime?
  reconciledBy      String?

  // Timestamps
  scheduledFor      DateTime?
  processedAt       DateTime?
  settledAt         DateTime?
  failedAt          DateTime?
  failureReason     String?         @db.Text
  retryCount        Int             @default(0)

  // Idempotency
  idempotencyKey    String?         @unique

  createdAt         DateTime        @default(now())

  @@index([advanceId, type])
  @@index([advanceId, createdAt])
  @@index([paymentStatus])
  @@index([type, createdAt])
  @@index([transactionNumber])
  @@map("advance_transactions")
}

/// Advance Status History - Audit trail of status changes
model AdvanceStatusHistory {
  id                String          @id @default(uuid())

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  fromStatus        AdvanceStatus?
  toStatus          AdvanceStatus

  // Change metadata
  changedBy         String?
  changedByName     String?         @db.VarChar(200)
  changedByRole     String?         @db.VarChar(50)

  reason            String?         @db.Text
  automaticChange   Boolean         @default(false)
  metadata          Json?

  // IP and device (for security audit)
  ipAddress         String?         @db.VarChar(45)
  userAgent         String?         @db.Text

  createdAt         DateTime        @default(now())

  @@index([advanceId, createdAt])
  @@index([toStatus, createdAt])
  @@map("advance_status_history")
}

/// Advance Document - Document storage references
model AdvanceDocument {
  id                String          @id @default(uuid())

  advanceId         String
  advance           AdvanceContract @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  documentType      AdvanceDocumentType
  fileName          String          @db.VarChar(500)
  fileSize          Int
  mimeType          String          @db.VarChar(100)

  // Storage
  storageProvider   String          @default("S3")
  storageKey        String          @db.VarChar(1000)
  storageUrl        String?         @db.Text
  urlExpiresAt      DateTime?

  // Security
  isEncrypted       Boolean         @default(false)
  encryptionKeyRef  String?
  checksumSHA256    String?         @db.VarChar(64)

  // Metadata
  uploadedBy        String
  uploadedByName    String          @db.VarChar(200)
  description       String?         @db.Text
  metadata          Json?

  // Virus scan
  isScanned         Boolean         @default(false)
  scanResult        String?
  scannedAt         DateTime?

  createdAt         DateTime        @default(now())
  deletedAt         DateTime?

  @@index([advanceId, documentType])
  @@index([documentType, createdAt])
  @@map("advance_documents")
}

// ════════════════════════════════════════════════════════════════════════════════
// PHASE 2: BLOCKCHAIN-BACKED INVOICES
// CFDI 4.0 + Blockchain Hash = Unforgeable Financial Documents
// ════════════════════════════════════════════════════════════════════════════════

/// Invoice status tracking
enum InvoiceStatus {
  DRAFT             // Invoice created but not finalized
  PENDING           // Awaiting CFDI generation
  ISSUED            // CFDI generated, pending blockchain
  BLOCKCHAIN_PENDING // Awaiting blockchain confirmation
  VERIFIED          // Fully verified (CFDI + Blockchain)
  CANCELLED         // Invoice cancelled
  FAILED            // Generation failed
}

/// Invoice model with dual verification (SAT + Blockchain)
model Invoice {
  id                String        @id @default(uuid())

  // Parties
  userId            String        // Seller
  producerId        String?       // Optional: if linked to producer
  buyerId           String?       // Optional: buyer reference
  batchId           String?       // Optional: if linked to batch

  // CFDI 4.0 Fields (Mexican tax invoice)
  folio             String        @unique
  uuid              String        @unique // Fiscal UUID from SAT
  serie             String?       @db.VarChar(10)

  // Financial Details
  subtotal          Decimal       @db.Decimal(15, 2)
  iva               Decimal       @db.Decimal(15, 2) @default(0)
  ivaRate           Decimal       @db.Decimal(5, 2) @default(16)
  isr               Decimal       @db.Decimal(15, 2) @default(0)
  total             Decimal       @db.Decimal(15, 2)
  currency          String        @default("MXN") @db.VarChar(3)
  exchangeRate      Decimal?      @db.Decimal(10, 6)

  // Recipient Info
  recipientRfc      String        @db.VarChar(13)
  recipientName     String        @db.VarChar(255)
  recipientEmail    String?       @db.VarChar(255)

  // Document Storage
  pdfUrl            String?       @db.Text
  xmlUrl            String?       @db.Text
  qrCodeUrl         String?       @db.Text

  // CFDI Stamp (from SAT/Facturama)
  cfdiSeal          String?       @db.Text
  satSeal           String?       @db.Text
  certificateNumber String?       @db.VarChar(50)
  satCertNumber     String?       @db.VarChar(50)
  stampDate         DateTime?

  // Blockchain Verification (Phase 2 Core Feature)
  blockchainHash    String?       @db.VarChar(66)
  blockchainTxHash  String?       @db.VarChar(66)
  blockchainNetwork String?       @default("polygon")
  blockchainVerified Boolean      @default(false)
  blockchainTimestamp DateTime?

  // Status
  status            InvoiceStatus @default(DRAFT)

  // Audit
  issuedAt          DateTime?
  cancelledAt       DateTime?
  cancellationReason String?      @db.Text

  // Metadata
  notes             String?       @db.Text
  metadata          Json?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([producerId])
  @@index([uuid])
  @@index([folio])
  @@index([status])
  @@index([createdAt])
  @@index([blockchainVerified])
  @@map("invoices")
}

// ════════════════════════════════════════════════════════════════════════════════
// PHASE 3: BLOCKCHAIN-VERIFIED REFERRAL PROGRAM
// On-chain proof of referrals = prevents gaming/Sybil attacks
// ════════════════════════════════════════════════════════════════════════════════

/// Referral status lifecycle
enum ReferralStatus {
  PENDING           // Referral code applied, waiting for signup
  REGISTERED        // Referred user completed registration
  ACTIVE            // Referred user is active (some activity)
  COMPLETED         // 30-day active milestone reached (reward unlocked)
  EXPIRED           // Referral expired (no activity in 30 days)
  CANCELLED         // Referral cancelled
  FRAUD_SUSPECTED   // Flagged for review
}

/// Referral reward types
enum ReferralRewardType {
  PREMIUM_DAYS      // Free premium subscription days
  CASH_BONUS        // Cash bonus (for future)
  CREDIT_BONUS      // Credit limit increase
  FEE_DISCOUNT      // Discount on platform fees
}

/// Referral model with blockchain proof
model Referral {
  id                String          @id @default(uuid())

  // Parties
  referrerId        String          // User who referred
  referredId        String?         // User who was referred (nullable until signup)

  // Referral Code
  referralCode      String          @db.VarChar(20)

  // Status Tracking
  status            ReferralStatus  @default(PENDING)

  // Activity Metrics (for 30-day validation)
  activityScore     Int             @default(0)
  batchesCreated    Int             @default(0)
  loginCount        Int             @default(0)
  lastActivityAt    DateTime?

  // Reward Details
  rewardType        ReferralRewardType @default(PREMIUM_DAYS)
  rewardValue       Int                @default(30) // e.g., 30 days premium
  rewardGranted     Boolean            @default(false)
  rewardGrantedAt   DateTime?

  // Blockchain Proof (Phase 3 Core Feature)
  blockchainTxHash  String?         @db.VarChar(66)
  blockchainEventId String?         @db.VarChar(66)
  blockchainVerified Boolean        @default(false)
  blockchainNetwork String?         @default("polygon")

  // Leaderboard
  monthYear         String          @db.VarChar(7) // Format: 2025-01 for leaderboard grouping

  // Fraud Prevention
  ipAddress         String?         @db.VarChar(45)
  deviceFingerprint String?         @db.VarChar(255)
  isSuspicious      Boolean         @default(false)
  suspicionReasons  String[]

  // Audit
  appliedAt         DateTime        @default(now())
  registeredAt      DateTime?
  completedAt       DateTime?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
  @@index([status])
  @@index([monthYear, status])
  @@index([blockchainVerified])
  @@map("referrals")
}

/// User's referral code (one per user)
model UserReferralCode {
  id                String    @id @default(uuid())
  userId            String    @unique

  // Unique referral code for this user
  code              String    @unique @db.VarChar(20)

  // Statistics
  totalReferrals    Int       @default(0)
  activeReferrals   Int       @default(0)
  completedReferrals Int      @default(0)

  // Rewards Earned
  totalRewardsEarned Int      @default(0) // Total premium days or equivalent

  // Blockchain Stats
  onChainReferrals  Int       @default(0)
  walletAddress     String?   @db.VarChar(42)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([code])
  @@index([userId])
  @@map("user_referral_codes")
}

/// Monthly Referral Leaderboard (cached for performance)
model ReferralLeaderboard {
  id                String    @id @default(uuid())

  // Period
  monthYear         String    @db.VarChar(7) // Format: 2025-01

  // User
  userId            String
  userName          String    @db.VarChar(255)
  userAvatar        String?   @db.VarChar(500)

  // Stats
  rank              Int
  activeReferrals   Int       @default(0)
  completedReferrals Int      @default(0)
  totalPoints       Int       @default(0)

  // Blockchain Verification
  blockchainVerified Boolean  @default(false)
  walletAddress     String?   @db.VarChar(42)

  // Prize (if winner)
  prizeAmount       Decimal?  @db.Decimal(12, 2)
  prizeType         String?   @db.VarChar(50)
  prizeAwarded      Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([monthYear, userId])
  @@index([monthYear, rank])
  @@index([userId])
  @@map("referral_leaderboard")
}

// ════════════════════════════════════════════════════════════════════════════════
// API KEY MANAGEMENT
// Enterprise-grade API key system for programmatic access
// Supports machine-to-machine authentication for integrations
// ════════════════════════════════════════════════════════════════════════════════

/// API Key status
enum ApiKeyStatus {
  ACTIVE      // Key is active and can be used
  REVOKED     // Key has been manually revoked
  EXPIRED     // Key has passed its expiration date
  SUSPENDED   // Key is temporarily suspended
}

/// API Key scope/permission levels
enum ApiKeyScope {
  READ        // Read-only access
  WRITE       // Read and write access
  ADMIN       // Full administrative access
}

/// API Key model for programmatic access
model ApiKey {
  id            String       @id @default(uuid())

  // Owner
  userId        String

  // Key identification (only prefix stored, hash for validation)
  keyPrefix     String       @db.VarChar(12) // First 12 chars for identification (e.g., "ab_live_xxxx")
  keyHash       String       @unique         // SHA-256 hash of full key for validation

  // Metadata
  label         String       @db.VarChar(100) // User-friendly name (e.g., "Production Integration")
  description   String?      @db.Text

  // Permissions
  scopes        ApiKeyScope[] @default([READ])

  // Status & Lifecycle
  status        ApiKeyStatus @default(ACTIVE)
  expiresAt     DateTime?    // Optional expiration (null = never expires)
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?      @db.VarChar(500)

  // Usage tracking
  lastUsedAt    DateTime?
  lastUsedIp    String?      @db.VarChar(45)
  usageCount    Int          @default(0)

  // Rate limiting (per-key limits)
  rateLimitRpm  Int          @default(100)  // Requests per minute

  // Security
  allowedIps    String[]     // IP whitelist (empty = allow all)
  allowedOrigins String[]    // Origin whitelist for CORS

  // Audit
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
  @@index([keyHash])
  @@index([status])
  @@index([keyPrefix])
  @@map("api_keys")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - MULTI-STAGE VERIFICATION
// End-to-end supply chain verification with blockchain anchoring
// ════════════════════════════════════════════════════════════════════════════════

/// Verification stage types following supply chain flow
enum StageType {
  HARVEST        // Initial harvest at farm
  PACKING        // Processing and packaging
  COLD_CHAIN     // Cold storage verification
  EXPORT         // Export customs clearance
  DELIVERY       // Final delivery to buyer
}

/// Verification stage status
enum StageStatus {
  PENDING        // Stage created, awaiting action
  IN_PROGRESS    // Stage being verified
  APPROVED       // Stage passed verification
  REJECTED       // Stage failed verification
  FLAGGED        // Stage requires additional review
}

/// Multi-stage verification for supply chain
model VerificationStage {
  id            String      @id @default(uuid())
  batchId       String
  batch         Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)

  stageType     StageType
  status        StageStatus @default(PENDING)

  // Actor who performed/verified this stage
  actorId       String
  timestamp     DateTime    @default(now())

  // Location data
  location      String?
  latitude      Decimal?    @db.Decimal(10, 8)
  longitude     Decimal?    @db.Decimal(11, 8)

  // Evidence & notes
  notes         String?     @db.Text
  evidenceUrl   String?

  // Blockchain anchoring (set when batch stages are finalized)
  hashOnChain   String?
  txId          String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([batchId, stageType])
  @@index([batchId])
  @@index([stageType])
  @@index([status])
  @@index([actorId])
  @@map("verification_stages")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - BLOCKCHAIN QUALITY CERTIFICATES
// Immutable quality certificates with hash verification
// ════════════════════════════════════════════════════════════════════════════════

/// Certificate grade levels
enum CertificateGrade {
  STANDARD       // Basic quality certification (HARVEST + PACKING)
  PREMIUM        // Premium grade (+ COLD_CHAIN)
  EXPORT         // Export quality (all stages)
  ORGANIC        // Organic certification (all stages + organic verification)
}

/// Quality certificates issued for batches
model QualityCertificate {
  id              String          @id @default(uuid())
  batchId         String
  batch           Batch           @relation(fields: [batchId], references: [id], onDelete: Cascade)

  grade           CertificateGrade
  certifyingBody  String          // Organization that issued the certificate

  validFrom       DateTime
  validTo         DateTime

  // Hash for integrity verification
  hashOnChain     String?
  pdfUrl          String?         // Generated PDF certificate URL

  // Payload snapshot for hash verification
  payloadSnapshot String?         @db.Text

  issuedAt        DateTime        @default(now())
  issuedBy        String          // User ID who issued

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([batchId])
  @@index([grade])
  @@index([certifyingBody])
  @@index([validFrom, validTo])
  @@map("quality_certificates")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - REAL-TIME TRANSIT TRACKING
// GPS-based transit monitoring with geofencing alerts
// ════════════════════════════════════════════════════════════════════════════════

/// Transit session status
enum TransitStatus {
  SCHEDULED      // Transit planned but not started
  IN_TRANSIT     // Currently in transit
  PAUSED         // Transit temporarily paused (e.g., rest stop)
  DELAYED        // Transit delayed from schedule
  COMPLETED      // Transit completed successfully
  CANCELLED      // Transit cancelled
}

/// Transit session for a batch shipment
model TransitSession {
  id              String        @id @default(uuid())
  batchId         String
  batch           Batch         @relation(fields: [batchId], references: [id], onDelete: Cascade)

  status          TransitStatus @default(SCHEDULED)
  driverId        String        // User ID of driver
  vehicleId       String?       // Vehicle identifier

  // Route information
  originName      String
  originLat       Decimal       @db.Decimal(10, 8)
  originLng       Decimal       @db.Decimal(11, 8)
  destinationName String
  destinationLat  Decimal       @db.Decimal(10, 8)
  destinationLng  Decimal       @db.Decimal(11, 8)

  // Timing
  scheduledDeparture DateTime?
  actualDeparture    DateTime?
  scheduledArrival   DateTime?
  actualArrival      DateTime?
  estimatedArrival   DateTime?  // Updated ETA based on current location

  // Distance tracking
  totalDistanceKm    Decimal?   @db.Decimal(10, 2)
  distanceTraveledKm Decimal?   @db.Decimal(10, 2)

  // Geofence settings
  maxDeviationKm     Decimal    @default(5.0) @db.Decimal(5, 2)
  alertOnDeviation   Boolean    @default(true)

  // Location updates
  locations       TransitLocation[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([batchId])
  @@index([driverId])
  @@index([status])
  @@index([scheduledDeparture])
  @@map("transit_sessions")
}

/// GPS location updates during transit
model TransitLocation {
  id              String        @id @default(uuid())
  sessionId       String
  session         TransitSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  latitude        Decimal       @db.Decimal(10, 8)
  longitude       Decimal       @db.Decimal(11, 8)
  altitude        Decimal?      @db.Decimal(8, 2)
  accuracy        Decimal?      @db.Decimal(6, 2) // GPS accuracy in meters
  speed           Decimal?      @db.Decimal(6, 2) // Speed in km/h
  heading         Decimal?      @db.Decimal(5, 2) // Direction in degrees

  // Location metadata
  address         String?       // Reverse geocoded address
  isOffRoute      Boolean       @default(false)
  deviationKm     Decimal?      @db.Decimal(6, 2)

  timestamp       DateTime      @default(now())

  @@index([sessionId])
  @@index([timestamp])
  @@index([isOffRoute])
  @@map("transit_locations")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - COLD CHAIN TEMPERATURE LOG
// Continuous temperature monitoring with threshold alerts
// ════════════════════════════════════════════════════════════════════════════════

/// Temperature reading source
enum TemperatureSource {
  IOT_SENSOR     // Automated IoT sensor reading
  MANUAL         // Manual entry by operator
  DRIVER_APP     // Reading from driver mobile app
}

/// Temperature readings for cold chain monitoring
model TemperatureReading {
  id              String            @id @default(uuid())
  batchId         String
  batch           Batch             @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Reading data
  value           Decimal           @db.Decimal(5, 2) // Temperature in Celsius
  humidity        Decimal?          @db.Decimal(5, 2) // Humidity percentage
  source          TemperatureSource

  // Threshold monitoring
  minThreshold    Decimal           @default(0.0) @db.Decimal(5, 2)
  maxThreshold    Decimal           @default(8.0) @db.Decimal(5, 2)
  isOutOfRange    Boolean           @default(false)

  // Sensor/device info
  sensorId        String?
  deviceId        String?

  // Location (if mobile reading)
  latitude        Decimal?          @db.Decimal(10, 8)
  longitude       Decimal?          @db.Decimal(11, 8)

  recordedBy      String?           // User ID for manual readings
  timestamp       DateTime          @default(now())

  @@index([batchId])
  @@index([timestamp])
  @@index([isOutOfRange])
  @@index([sensorId])
  @@map("temperature_readings")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - TAMPER-EVIDENT NFC SEALS
// NFC tag verification for package integrity
// ════════════════════════════════════════════════════════════════════════════════

/// NFC seal status
enum NfcSealStatus {
  ACTIVE         // Seal is active and intact
  VERIFIED       // Seal recently verified as intact
  TAMPERED       // Seal shows signs of tampering
  REMOVED        // Seal has been removed
  EXPIRED        // Seal past its validity period
}

/// NFC seal attached to batch packaging
model NfcSeal {
  id              String        @id @default(uuid())
  batchId         String
  batch           Batch         @relation(fields: [batchId], references: [id], onDelete: Cascade)

  uid             String        @unique // NFC tag unique identifier
  status          NfcSealStatus @default(ACTIVE)

  // Seal metadata
  sealNumber      String?       // Physical seal number
  appliedAt       DateTime      @default(now())
  appliedBy       String        // User ID who applied seal
  appliedLocation String?

  // Verification tracking
  lastVerifiedAt  DateTime?
  lastVerifiedBy  String?
  verificationCount Int         @default(0)

  // Validity
  validUntil      DateTime?

  // Blockchain anchoring
  hashOnChain     String?

  verifications   NfcSealVerification[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([batchId])
  @@index([uid])
  @@index([status])
  @@map("nfc_seals")
}

/// NFC seal verification history
model NfcSealVerification {
  id              String        @id @default(uuid())
  sealId          String
  seal            NfcSeal       @relation(fields: [sealId], references: [id], onDelete: Cascade)

  verifiedBy      String        // User ID
  verifiedAt      DateTime      @default(now())

  // Verification result
  isValid         Boolean
  tamperDetected  Boolean       @default(false)
  notes           String?       @db.Text

  // Location of verification
  latitude        Decimal?      @db.Decimal(10, 8)
  longitude       Decimal?      @db.Decimal(11, 8)
  location        String?

  // Device info
  deviceId        String?
  deviceType      String?

  @@index([sealId])
  @@index([verifiedAt])
  @@index([verifiedBy])
  @@map("nfc_seal_verifications")
}

// ════════════════════════════════════════════════════════════════════════════════
// ORGANIC CERTIFICATION INFRASTRUCTURE
// B2B Export Company model for organic certification pivot
// Phase 1: Revenue Sprint - Export companies as primary customers
// ════════════════════════════════════════════════════════════════════════════════

/// Subscription tier for export companies
enum ExportCompanyTier {
  STARTER      // 10 farmers, 50 certs/month, $500/mo
  PROFESSIONAL // 50 farmers, 200 certs/month, $1,000/mo
  ENTERPRISE   // Unlimited farmers, unlimited certs, $2,000/mo
}

/// Export company account status
enum ExportCompanyStatus {
  TRIAL        // 14-day trial period
  ACTIVE       // Paying customer
  SUSPENDED    // Payment failed or policy violation
  CANCELLED    // Churned customer
}

/// Export company - B2B customer entity (primary revenue source)
model ExportCompany {
  id                String              @id @default(uuid())

  // Company identification
  name              String              // Display name
  legalName         String?             // Razón social for invoicing
  rfc               String              @unique // Mexican tax ID (RFC)
  email             String              @unique // Primary contact email
  phone             String?

  // Address
  country           String              @default("MX")
  state             String?
  city              String?
  address           String?             @db.Text
  postalCode        String?             @db.VarChar(10)

  // Primary contact person
  contactName       String
  contactEmail      String
  contactPhone      String?

  // Subscription & billing
  tier              ExportCompanyTier   @default(STARTER)
  status            ExportCompanyStatus @default(TRIAL)
  trialEndsAt       DateTime?
  monthlyFee        Decimal             @db.Decimal(10, 2)
  certificateFee    Decimal             @db.Decimal(10, 2) @default(10.00)
  farmersIncluded   Int                 @default(10)
  certsIncluded     Int                 @default(50)

  // Stripe billing integration
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?

  // Certification standards enabled for this company
  enabledStandards  CertificationType[]

  // White-label branding
  logoUrl           String?             @db.VarChar(500)
  primaryColor      String?             @db.VarChar(7) @default("#22C55E")

  // Admin users who manage this company
  adminUsers        User[]              @relation("ExportCompanyAdmins")

  // Farmers enrolled under this export company
  farmers           Producer[]          @relation("ExportCompanyFarmers")

  // Farmer invitations sent by this company
  invitations       FarmerInvitation[]

  // Organic certificates issued for this company's farmers
  organicCertificates OrganicCertificate[]

  // Billing invoices
  invoices          ExportCompanyInvoice[]

  // Smart-Cold Chain Protocol
  iotSensors        IoTSensor[]           @relation("CompanySensors")
  coldChainSessions ColdChainSession[]    @relation("CompanyColdChainSessions")
  qualityMetrics    HarvestQualityMetrics[] @relation("CompanyQualityMetrics")

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([status])
  @@index([tier])
  @@index([stripeCustomerId])
  @@index([rfc])
  @@map("export_companies")
}

/// Farmer invitation status for B2B2C enrollment flow
enum FarmerInvitationStatus {
  PENDING    // Invitation sent, awaiting farmer action
  ACCEPTED   // Farmer completed registration
  EXPIRED    // Invitation expired (7 days default)
  CANCELLED  // Export company cancelled the invitation
}

/// Farmer invitation - B2B2C enrollment flow
model FarmerInvitation {
  id                String                  @id @default(uuid())

  exportCompanyId   String
  exportCompany     ExportCompany           @relation(fields: [exportCompanyId], references: [id], onDelete: Cascade)

  // Invitation details
  email             String                  // Email to send invitation to
  phone             String?                 // Optional phone for SMS/WhatsApp
  farmerName        String?                 // Optional pre-fill name

  // Security token for signup link
  inviteToken       String                  @unique @default(uuid())

  // Status tracking
  status            FarmerInvitationStatus  @default(PENDING)

  // Result - set when farmer registers
  farmerId          String?                 // Producer ID after registration

  // Timestamps
  sentAt            DateTime                @default(now())
  expiresAt         DateTime                // Default: 7 days from sentAt
  acceptedAt        DateTime?

  createdAt         DateTime                @default(now())

  @@index([exportCompanyId])
  @@index([inviteToken])
  @@index([email])
  @@index([status])
  @@map("farmer_invitations")
}

// ════════════════════════════════════════════════════════════════════════════════
// ORGANIC CERTIFICATION - ORGANIC FIELD ENTITY
// Extended field model for organic certification tracking
// ════════════════════════════════════════════════════════════════════════════════

/// Organic certification status for a field
enum OrganicFieldStatus {
  PENDING_VERIFICATION  // Newly declared, needs initial inspection
  TRANSITIONAL          // In 36-month organic transition period
  CERTIFIED             // Fully organic certified
  SUSPENDED             // Certification suspended (violation)
  REVOKED               // Certification revoked
}

/// Extended organic field entity for certification tracking
model OrganicField {
  id                String              @id @default(uuid())

  // Link to base Field entity (for satellite imagery integration)
  baseFieldId       String?             @unique
  baseField         Field?              @relation(fields: [baseFieldId], references: [id])

  producerId        String
  producer          Producer            @relation(fields: [producerId], references: [id], onDelete: Cascade)

  // Field identification
  name              String
  localIdentifier   String?             // Farmer's local name/number for field

  // Crop information
  cropType          String              // AVOCADO, BLUEBERRY, RASPBERRY, STRAWBERRY
  variety           String?             // HASS, ORGANIC_DRISCOLL, etc.

  // Geographic boundaries
  areaHectares      Decimal             @db.Decimal(10, 4)
  boundaryGeoJson   String              @db.Text // GeoJSON polygon for GPS verification
  centerLat         Decimal             @db.Decimal(10, 8)
  centerLng         Decimal             @db.Decimal(11, 8)
  altitude          Decimal?            @db.Decimal(6, 2) // Meters above sea level

  // Organic history
  organicSince      DateTime?           // Date organic practices started
  lastConventional  DateTime?           // Last date of conventional input use
  transitionEndDate DateTime?           // When 36-month transition period ends

  // Certification status
  certificationStatus OrganicFieldStatus @default(PENDING_VERIFICATION)
  certifiedStandards CertificationType[] // ORGANIC_USDA, ORGANIC_EU, SENASICA

  // Water sources
  waterSources      String[]            // WELL, RIVER, RAIN, MUNICIPAL
  irrigationType    String?             // DRIP, SPRINKLER, FLOOD

  // Soil information
  soilType          String?
  lastSoilTestDate  DateTime?

  // Field inspections
  inspections       FieldInspection[]

  // Active status
  isActive          Boolean             @default(true)

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([producerId])
  @@index([certificationStatus])
  @@index([cropType])
  // Satellite compliance analyses
  satelliteAnalyses SatelliteAnalysis[]

  @@map("organic_fields")
}

// ════════════════════════════════════════════════════════════════════════════════
// SATELLITE COMPLIANCE ANALYSIS
// NDVI-based organic compliance verification using Sentinel-2 satellite data
// Detects synthetic fertilizer patterns with 90%+ confidence
// ════════════════════════════════════════════════════════════════════════════════

/// Satellite compliance status
enum SatelliteComplianceStatus {
  PROCESSING     // Analysis in progress
  ELIGIBLE       // No violations detected - eligible for organic certification
  INELIGIBLE     // Clear violations detected (synthetic fertilizer)
  NEEDS_REVIEW   // Borderline cases requiring human review
  FAILED         // Technical error during analysis
}

/// Satellite analysis for organic compliance
model SatelliteAnalysis {
  id                  String   @id @default(uuid())

  // Relationship to organic field
  organicFieldId      String
  organicField        OrganicField @relation(fields: [organicFieldId], references: [id], onDelete: Cascade)

  // Analysis parameters
  analysisStartDate   DateTime
  analysisEndDate     DateTime
  analysisYears       Int      @default(3)
  cropType            String   // AVOCADO, BLUEBERRY, etc.

  // Data coverage
  totalDataPoints     Int      @default(0)
  validDataPoints     Int      @default(0)  // Excluding cloudy days
  dataCoveragePercent Decimal  @db.Decimal(5, 2) @default(0)

  // NDVI time series (JSON array of NDVIDataPoint)
  ndviHistory         Json     @default("[]")

  // Compliance assessment
  complianceStatus    SatelliteComplianceStatus @default(PROCESSING)
  overallConfidence   Decimal  @db.Decimal(3, 2) @default(0) // 0.00 to 1.00

  // Violations (JSON array of ViolationFlag)
  detectedViolations  Json     @default("[]")
  violationCount      Int      @default(0)
  highSeverityCount   Int      @default(0)

  // Report artifacts (S3 URLs)
  reportPdfUrl        String?
  chartImageUrl       String?
  rawDataUrl          String?  // JSON export for auditors

  // Performance metrics
  processingTimeMs    Int      @default(0)
  sentinelApiCalls    Int      @default(0)

  // Request tracking
  requestedBy         String   // User ID who requested analysis

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  expiresAt           DateTime // 90 days retention

  @@index([organicFieldId])
  @@index([complianceStatus])
  @@index([createdAt])
  @@index([requestedBy])
  @@map("satellite_analyses")
}

// ════════════════════════════════════════════════════════════════════════════════
// ORGANIC CERTIFICATION - FIELD INSPECTION
// Weekly/monthly field inspection records with photo evidence
// ════════════════════════════════════════════════════════════════════════════════

/// Inspection type classification
enum InspectionType {
  ROUTINE           // Regular weekly/monthly inspection by farmer
  PRE_CERTIFICATION // Before issuing organic certificate
  AUDIT             // Third-party audit inspection
  COMPLAINT         // Investigation of complaint/issue
}

/// Field inspection record with evidence
model FieldInspection {
  id                String            @id @default(uuid())

  fieldId           String
  field             OrganicField      @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Inspector information
  inspectorId       String            // User ID who conducted inspection
  inspectorName     String            // Snapshot of name at time of inspection
  inspectorRole     String            // FARMER, QA, CERTIFIER

  // Inspection metadata
  inspectionType    InspectionType    @default(ROUTINE)
  inspectionDate    DateTime
  duration          Int?              // Duration in minutes

  // Evidence collections
  photos            InspectionPhoto[]
  organicInputs     OrganicInput[]
  activities        FieldActivity[]

  // GPS verification of inspector location
  inspectorLat      Decimal?          @db.Decimal(10, 8)
  inspectorLng      Decimal?          @db.Decimal(11, 8)
  gpsAccuracy       Decimal?          @db.Decimal(6, 2) // Accuracy in meters
  gpsVerified       Boolean           @default(false)   // True if within field boundary

  // Weather conditions during inspection
  weatherCondition  String?           // SUNNY, CLOUDY, RAINY, etc.
  temperature       Decimal?          @db.Decimal(5, 2) // Temperature in Celsius

  // Inspector notes
  notes             String?           @db.Text
  issues            String?           @db.Text // Any problems found
  recommendations   String?           @db.Text

  // Verification by QA/certifier
  isVerified        Boolean           @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([fieldId])
  @@index([inspectionDate])
  @@index([inspectorId])
  @@index([inspectionType])
  @@map("field_inspections")
}

/// Inspection photo with GPS metadata for location verification
model InspectionPhoto {
  id                String            @id @default(uuid())

  inspectionId      String
  inspection        FieldInspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  // Photo storage
  imageUrl          String            @db.VarChar(500)
  thumbnailUrl      String?           @db.VarChar(500)

  // GPS from photo EXIF or capture device
  latitude          Decimal?          @db.Decimal(10, 8)
  longitude         Decimal?          @db.Decimal(11, 8)
  altitude          Decimal?          @db.Decimal(6, 2)

  // Capture timestamp
  capturedAt        DateTime

  // Photo metadata
  caption           String?           @db.VarChar(500)
  photoType         String?           // CROP, INPUT, PRACTICE, ISSUE

  // GPS verification against field boundary
  withinFieldBoundary Boolean         @default(false)
  distanceFromField Decimal?          @db.Decimal(8, 2) // Distance in meters if outside

  createdAt         DateTime          @default(now())

  @@index([inspectionId])
  @@map("inspection_photos")
}

/// Organic input record (fertilizer, pesticide) with receipt verification
model OrganicInput {
  id                String            @id @default(uuid())

  inspectionId      String
  inspection        FieldInspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  // Input identification
  productName       String
  brandName         String?
  manufacturer      String?

  // Classification
  inputType         String            // FERTILIZER, PESTICIDE, HERBICIDE, SOIL_AMENDMENT

  // Organic certification status
  isOmriListed      Boolean           @default(false) // OMRI organic listed
  isOrganicApproved Boolean           @default(false)
  certificationNumber String?

  // Purchase evidence
  receiptUrl        String?           @db.VarChar(500)
  receiptDate       DateTime?
  quantity          String?           // e.g., "5 liters", "20 kg"
  supplier          String?

  // OCR data from receipt scan
  ocrExtractedData  Json?
  ocrConfidence     Decimal?          @db.Decimal(3, 2) // 0.00-1.00

  // Verification status
  verificationStatus String           @default("PENDING") // PENDING, VERIFIED, REJECTED
  verifiedBy        String?
  verifiedAt        DateTime?
  rejectionReason   String?           @db.Text

  createdAt         DateTime          @default(now())

  @@index([inspectionId])
  @@index([inputType])
  @@index([verificationStatus])
  @@map("organic_inputs")
}

/// Field activity log (planting, spraying, harvesting)
model FieldActivity {
  id                String            @id @default(uuid())

  inspectionId      String
  inspection        FieldInspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  // Activity details
  activityType      String            // PLANTING, SPRAYING, HARVESTING, PRUNING, IRRIGATION, WEEDING
  description       String?           @db.Text

  // Timing
  activityDate      DateTime
  duration          Int?              // Duration in minutes

  // Coverage
  areaCovered       Decimal?          @db.Decimal(10, 4) // Hectares

  // Workers
  workerCount       Int?

  // Notes
  notes             String?           @db.Text

  createdAt         DateTime          @default(now())

  @@index([inspectionId])
  @@index([activityType])
  @@map("field_activities")
}

// ════════════════════════════════════════════════════════════════════════════════
// ORGANIC CERTIFICATION - ORGANIC CERTIFICATE
// Blockchain-anchored organic certificates with QR verification
// ════════════════════════════════════════════════════════════════════════════════

/// Organic certificate status workflow
enum OrganicCertificateStatus {
  DRAFT             // Certificate created, not submitted
  PROCESSING        // PDF/blockchain generation in progress
  PENDING_REVIEW    // Submitted, awaiting export company review
  APPROVED          // Export company approved, blockchain anchored
  REJECTED          // Export company rejected
  REVOKED           // Certificate revoked post-approval
  BLOCKCHAIN_FAILED // Blockchain anchoring failed (retryable)
}

/// Organic certificate - the core deliverable product
model OrganicCertificate {
  id                    String                    @id @default(uuid())

  // Unique certificate number
  certificateNumber     String                    @unique // AGB-MX-2025-001234

  // Parties involved
  farmerId              String
  farmer                Producer                  @relation("FarmerOrganicCertificates", fields: [farmerId], references: [id])

  exportCompanyId       String
  exportCompany         ExportCompany             @relation(fields: [exportCompanyId], references: [id])

  // Fields covered by this certificate
  fieldIds              String[]                  // Array of OrganicField IDs

  // Crop information
  cropType              String                    // AVOCADO, BLUEBERRY, etc.
  variety               String?
  harvestDate           DateTime?
  estimatedWeight       Decimal?                  @db.Decimal(10, 2) // kg

  // Certification standard
  certificationStandard CertificationType         // ORGANIC_USDA, ORGANIC_EU, SENASICA

  // Validity period
  validFrom             DateTime
  validTo               DateTime

  // Status workflow
  status                OrganicCertificateStatus  @default(DRAFT)

  // Review process
  submittedAt           DateTime?
  reviewedBy            String?
  reviewedAt            DateTime?
  rejectionReason       String?                   @db.Text

  // Generated assets
  pdfUrl                String?                   @db.VarChar(500)
  qrCodeUrl             String?                   @db.VarChar(500)
  qrCodeShortUrl        String?                   @db.VarChar(100) // Short URL for QR

  // Blockchain anchoring
  contentHash           String?                   @db.VarChar(64) // SHA-256 of payload
  blockchainTxHash      String?                   @db.VarChar(66)
  blockchainNetwork     String?                   @default("polygon")
  blockchainTimestamp   DateTime?

  // IPFS storage
  ipfsHash              String?                   @db.VarChar(100) // CID for full metadata

  // Payload snapshot for hash verification
  payloadSnapshot       String?                   @db.Text

  // Verification analytics
  viewCount             Int                       @default(0)
  lastViewedAt          DateTime?

  // Verification logs
  verifications         OrganicCertificateVerification[]

  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  @@index([farmerId])
  @@index([exportCompanyId])
  @@index([status])
  @@index([certificateNumber])
  @@index([certificationStandard])
  @@map("organic_certificates")
}

/// Organic certificate verification log (QR scans by importers/retailers)
model OrganicCertificateVerification {
  id                String              @id @default(uuid())

  certificateId     String
  certificate       OrganicCertificate  @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  // Verifier context (privacy-safe, no PII)
  verifierType      String?             // IMPORTER, RETAILER, AUDITOR, CONSUMER

  // Privacy-safe tracking
  country           String?             @db.VarChar(2) // From geoIP
  deviceType        String?             // MOBILE, DESKTOP
  referrer          String?             @db.VarChar(500)

  verifiedAt        DateTime            @default(now())

  @@index([certificateId])
  @@index([verifiedAt])
  @@map("organic_certificate_verifications")
}

// ════════════════════════════════════════════════════════════════════════════════
// ORGANIC CERTIFICATION - EXPORT COMPANY BILLING
// Monthly SaaS invoices for export companies
// ════════════════════════════════════════════════════════════════════════════════

/// Export company invoice for B2B billing
model ExportCompanyInvoice {
  id                String          @id @default(uuid())

  exportCompanyId   String
  exportCompany     ExportCompany   @relation(fields: [exportCompanyId], references: [id])

  // Invoice identification
  invoiceNumber     String          @unique // INV-2025-0001

  // Billing period
  periodStart       DateTime
  periodEnd         DateTime

  // Line items (denormalized for invoice record)
  baseFee           Decimal         @db.Decimal(10, 2)
  farmerCount       Int
  certificateCount  Int
  overageCerts      Int             @default(0)
  overageFees       Decimal         @db.Decimal(10, 2) @default(0)

  // Totals
  subtotal          Decimal         @db.Decimal(10, 2)
  tax               Decimal         @db.Decimal(10, 2) @default(0)
  total             Decimal         @db.Decimal(10, 2)
  currency          String          @default("USD") @db.VarChar(3)

  // Status
  status            String          @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED

  // Payment tracking
  stripeInvoiceId   String?
  paidAt            DateTime?
  paymentMethod     String?

  // PDF
  pdfUrl            String?         @db.VarChar(500)

  dueDate           DateTime
  createdAt         DateTime        @default(now())

  @@index([exportCompanyId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("export_company_invoices")
}

// ════════════════════════════════════════════════════════════════════════════════
// TRACEABILITY 2.0 - SATELLITE IMAGERY TIME-LAPSE
// Field monitoring via satellite imagery
// ════════════════════════════════════════════════════════════════════════════════

/// Agricultural field for satellite monitoring
model Field {
  id              String        @id @default(uuid())
  producerId      String
  producer        Producer      @relation(fields: [producerId], references: [id], onDelete: Cascade)

  name            String
  description     String?       @db.Text

  // Field boundaries (GeoJSON polygon)
  boundaryGeoJson String        @db.Text

  // Center point for quick reference
  centerLat       Decimal       @db.Decimal(10, 8)
  centerLng       Decimal       @db.Decimal(11, 8)

  // Field size
  areaHectares    Decimal       @db.Decimal(10, 4)

  // Crop information
  currentCrop     String?
  plantingDate    DateTime?
  expectedHarvest DateTime?

  // Satellite imagery
  imagery         FieldImagery[]

  // Organic certification relation
  organicField    OrganicField?

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([producerId])
  @@index([isActive])
  @@map("fields")
}

/// Satellite imagery for a field
model FieldImagery {
  id              String        @id @default(uuid())
  fieldId         String
  field           Field         @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Image metadata
  capturedAt      DateTime
  source          String        // Sentinel-2, Landsat, etc.
  resolution      Decimal       @db.Decimal(6, 2) // Meters per pixel
  cloudCoverPct   Decimal?      @db.Decimal(5, 2)

  // Image URLs
  rgbUrl          String?       // True color image
  ndviUrl         String?       // NDVI vegetation index
  moistureUrl     String?       // Soil moisture index
  thermalUrl      String?       // Thermal image

  // Computed indices
  ndviValue       Decimal?      @db.Decimal(4, 3) // Average NDVI (-1 to 1)
  healthScore     Decimal?      @db.Decimal(5, 2) // Computed health score (0-100)

  // Analysis notes
  anomalyDetected Boolean       @default(false)
  analysisNotes   String?       @db.Text

  createdAt       DateTime      @default(now())

  @@index([fieldId])
  @@index([capturedAt])
  @@index([anomalyDetected])
  @@map("field_imagery")
}

// ════════════════════════════════════════════════════════════════════════════════
// SMART-COLD CHAIN PROTOCOL
// IoT-enabled cold chain monitoring and agronomic quality verification
// for US/EU export compliance. Real-time temperature/humidity + Brix/pH metrics.
// ════════════════════════════════════════════════════════════════════════════════

/// IoT Sensor status
enum IoTSensorStatus {
  ACTIVE
  OFFLINE
  LOW_BATTERY
  MAINTENANCE
  DECOMMISSIONED
}

/// Cold chain session type
enum ColdChainSessionType {
  FIELD_MONITORING
  HARVEST_COOLING
  COLD_STORAGE
  TRANSPORT
}

/// Cold chain session status
enum ColdChainSessionStatus {
  ACTIVE
  COMPLETED
  BREACHED
  NEEDS_REVIEW
  EXPIRED
}

/// Quality grade for export eligibility
enum ColdChainQualityGrade {
  PREMIUM      // A++ Export quality (top 10%)
  EXPORT       // A/B Export standard
  DOMESTIC     // B/C Domestic market only
  REJECT       // Below standard
}

/// Breach type classification
enum ColdChainBreachType {
  OVER_TEMP
  UNDER_TEMP
  HUMIDITY_HIGH
  HUMIDITY_LOW
}

/// Breach severity levels
enum ColdChainBreachSeverity {
  LOW          // <1°C deviation, <10 min
  MEDIUM       // 1-3°C deviation, 10-30 min
  HIGH         // 3-5°C deviation, 30-60 min
  CRITICAL     // >5°C deviation or >60 min
}

/// Alert types for notification system
enum ColdChainAlertType {
  TEMPERATURE_BREACH
  HUMIDITY_BREACH
  SENSOR_OFFLINE
  QUALITY_DECLINE
  BATTERY_LOW
}

/// Alert severity levels
enum ColdChainAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

/// Crop type for cold chain requirements
enum ColdChainCropType {
  AVOCADO
  BLUEBERRY
  STRAWBERRY
  RASPBERRY
  COFFEE
  CACAO
}

/// IoT Sensor device for cold chain monitoring
model IoTSensor {
  id                String          @id @default(uuid())

  // Device identification
  deviceId          String          @unique // MAC address or serial number
  deviceType        String          // TEMP_HUMIDITY, BRIX_METER, MULTIFUNCTION
  manufacturer      String?
  firmwareVersion   String?
  name              String?         // Friendly name for the sensor

  // Ownership
  exportCompanyId   String
  exportCompany     ExportCompany   @relation("CompanySensors", fields: [exportCompanyId], references: [id], onDelete: Cascade)

  // Current assignment
  assignedTo        String?         // fieldId, batchId, or shipmentId
  assignedType      String?         // FIELD, BATCH, SHIPMENT, STORAGE

  // Status
  status            IoTSensorStatus @default(ACTIVE)
  lastReadingAt     DateTime?
  batteryLevel      Int?            // 0-100

  // Calibration
  calibratedAt      DateTime?
  calibratedBy      String?
  calibrationDueAt  DateTime?

  // Readings
  readings          ColdChainReading[]

  // Sessions this sensor is part of
  sessions          ColdChainSession[] @relation("SessionSensors")

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([exportCompanyId])
  @@index([deviceId])
  @@index([status])
  @@index([assignedTo])
  @@map("iot_sensors")
}

/// Sensor reading from IoT device
model ColdChainReading {
  id                String            @id @default(uuid())

  // Source sensor
  sensorId          String
  sensor            IoTSensor         @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  // Context
  sessionId         String?
  session           ColdChainSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  fieldId           String?
  batchId           String?
  shipmentId        String?

  // Environmental data
  temperature       Decimal           @db.Decimal(5, 2) // Celsius (-40.00 to 100.00)
  humidity          Decimal?          @db.Decimal(5, 2) // Percentage 0.00 to 100.00
  batteryLevel      Int?              // 0-100

  // Quality metrics (if sensor supports)
  brixLevel         Decimal?          @db.Decimal(4, 2) // Sugar content °Brix (0.00 to 30.00)
  phLevel           Decimal?          @db.Decimal(3, 2) // Acidity 0.00 to 14.00
  firmness          Decimal?          @db.Decimal(6, 2) // Newton

  // Location
  gpsLat            Decimal?          @db.Decimal(10, 8)
  gpsLon            Decimal?          @db.Decimal(11, 8)

  // Compliance flags (computed at ingestion time)
  temperatureInRange Boolean          @default(true)
  humidityInRange   Boolean           @default(true)
  qualityGrade      ColdChainQualityGrade?

  // Timestamp
  readingTime       DateTime          @default(now())
  createdAt         DateTime          @default(now())

  @@index([sensorId, readingTime])
  @@index([sessionId])
  @@index([fieldId])
  @@index([batchId])
  @@index([readingTime])
  @@index([temperatureInRange])
  @@map("cold_chain_readings")
}

/// Cold chain monitoring session
model ColdChainSession {
  id                String                  @id @default(uuid())

  sessionType       ColdChainSessionType

  // Ownership
  exportCompanyId   String
  exportCompany     ExportCompany           @relation("CompanyColdChainSessions", fields: [exportCompanyId], references: [id], onDelete: Cascade)

  // Relationships
  fieldId           String?
  batchId           String?
  shipmentId        String?
  certificateId     String?                 // Link to organic certificate

  // Sensors assigned to this session
  sensors           IoTSensor[]             @relation("SessionSensors")

  // Readings for this session
  readings          ColdChainReading[]

  // Time bounds
  startTime         DateTime
  endTime           DateTime?
  durationMinutes   Int?

  // Crop-specific thresholds
  cropType          ColdChainCropType
  minTemperature    Decimal                 @db.Decimal(5, 2)
  maxTemperature    Decimal                 @db.Decimal(5, 2)
  targetHumidity    Decimal                 @db.Decimal(5, 2)

  // Computed metrics (updated on each reading)
  totalReadings     Int                     @default(0)
  compliantReadings Int                     @default(0)
  complianceScore   Decimal                 @db.Decimal(5, 2) @default(0) // 0.00 to 100.00
  breachCount       Int                     @default(0)
  maxTemperatureBreach Decimal?             @db.Decimal(5, 2) // Highest over-temp deviation
  breachDurationMinutes Int?

  // Quality scores
  avgTemperature    Decimal?                @db.Decimal(5, 2)
  minTemperatureRecorded Decimal?           @db.Decimal(5, 2)
  maxTemperatureRecorded Decimal?           @db.Decimal(5, 2)
  avgHumidity       Decimal?                @db.Decimal(5, 2)
  avgBrixLevel      Decimal?                @db.Decimal(4, 2)
  avgPhLevel        Decimal?                @db.Decimal(3, 2)
  qualityGrade      ColdChainQualityGrade?

  // Report artifacts
  complianceReportUrl String?               @db.VarChar(500)
  chartImageUrl     String?                 @db.VarChar(500)
  rawDataCsvUrl     String?                 @db.VarChar(500)

  status            ColdChainSessionStatus  @default(ACTIVE)

  // Breaches detected
  breaches          ColdChainBreach[]

  // Alerts generated
  alerts            ColdChainAlert[]

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([exportCompanyId])
  @@index([fieldId])
  @@index([batchId])
  @@index([status])
  @@index([startTime])
  @@index([cropType])
  @@map("cold_chain_sessions")
}

/// Temperature/humidity breach event
model ColdChainBreach {
  id                String                  @id @default(uuid())

  sessionId         String
  session           ColdChainSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  sensorId          String?                 // Which sensor detected the breach

  breachType        ColdChainBreachType
  severity          ColdChainBreachSeverity

  startTime         DateTime
  endTime           DateTime?
  durationMinutes   Int                     @default(0)

  threshold         Decimal                 @db.Decimal(5, 2)
  peakValue         Decimal                 @db.Decimal(5, 2) // Worst reading during breach
  avgValue          Decimal                 @db.Decimal(5, 2)

  // Actions taken
  alertSent         Boolean                 @default(false)
  alertedUsers      String[]                // Array of user IDs notified
  resolution        String?                 @db.Text // "Moved to cold room", "Discarded batch"
  resolvedBy        String?
  resolvedAt        DateTime?

  createdAt         DateTime                @default(now())

  @@index([sessionId])
  @@index([startTime])
  @@index([severity])
  @@index([alertSent])
  @@map("cold_chain_breaches")
}

/// Smart cold chain alert
model ColdChainAlert {
  id                String                  @id @default(uuid())

  alertType         ColdChainAlertType
  severity          ColdChainAlertSeverity

  sessionId         String
  session           ColdChainSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sensorId          String

  message           String                  @db.Text
  messageLang       String                  @default("es") @db.VarChar(5)

  currentValue      Decimal                 @db.Decimal(8, 2)
  threshold         Decimal                 @db.Decimal(8, 2)

  sent              Boolean                 @default(false)
  sentVia           String[]                // ["EMAIL", "SMS", "PUSH", "WEBHOOK"]
  sentAt            DateTime?
  acknowledgedBy    String?
  acknowledgedAt    DateTime?

  timestamp         DateTime                @default(now())

  @@index([sessionId])
  @@index([sent])
  @@index([timestamp])
  @@index([severity])
  @@map("cold_chain_alerts")
}

/// Quality metrics for harvest batches
model HarvestQualityMetrics {
  id                String                  @id @default(uuid())

  // Relationships
  fieldId           String?
  batchId           String?
  exportCompanyId   String
  exportCompany     ExportCompany           @relation("CompanyQualityMetrics", fields: [exportCompanyId], references: [id], onDelete: Cascade)

  harvestDate       DateTime
  cropType          ColdChainCropType
  sampleSize        Int?                    // Number of fruits sampled

  // Brix (sugar content)
  brixLevel         Decimal                 @db.Decimal(4, 2)
  brixGrade         String                  // EXCELLENT, GOOD, ACCEPTABLE, POOR
  brixCompliant     Boolean

  // pH (acidity)
  phLevel           Decimal                 @db.Decimal(3, 2)
  phGrade           String
  phCompliant       Boolean

  // Physical attributes
  firmness          Decimal?                @db.Decimal(6, 2) // Newton
  color             String?                 @db.VarChar(50)
  diameter          Decimal?                @db.Decimal(6, 2) // mm
  weight            Decimal?                @db.Decimal(8, 2) // grams (average)

  // Defects
  defectCount       Int                     @default(0)
  defectTypes       String[]                // ["bruising", "pest_damage", "rot"]
  defectPercentage  Decimal?                @db.Decimal(5, 2) // % of sample with defects

  // Final grade
  overallQuality    ColdChainQualityGrade
  exportEligible    Boolean
  marketPrice       Decimal?                @db.Decimal(8, 2) // USD/kg estimated

  // Lab verification
  labVerified       Boolean                 @default(false)
  labReportUrl      String?                 @db.VarChar(500)
  verifiedBy        String?
  verifiedAt        DateTime?

  // Measurement device info
  measurementDevice String?                 // Refractometer model, pH meter
  measurementMethod String?                 // Digital, analog, lab

  notes             String?                 @db.Text

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([fieldId])
  @@index([batchId])
  @@index([exportCompanyId])
  @@index([harvestDate])
  @@index([exportEligible])
  @@index([overallQuality])
  @@map("harvest_quality_metrics")
}
