;; ═══════════════════════════════════════════════════════════════════════════════
;; PGBOUNCER CONFIGURATION FOR AGROBRIDGE API
;; Production-grade connection pooling for PostgreSQL
;; ═══════════════════════════════════════════════════════════════════════════════

[databases]
;; Production database - use environment variable substitution in deployment
;; Format: dbname = host=<host> port=<port> dbname=<dbname> user=<user>
agrobridge = host=${DB_HOST} port=${DB_PORT} dbname=${DB_NAME} user=${DB_USER} password=${DB_PASSWORD}

;; Replica for read-heavy operations (optional)
;; agrobridge_ro = host=${DB_REPLICA_HOST} port=${DB_PORT} dbname=${DB_NAME} user=${DB_USER} password=${DB_PASSWORD}

[pgbouncer]
;; ═══════════════════════════════════════════════════════════════════════════════
;; CONNECTION SETTINGS
;; ═══════════════════════════════════════════════════════════════════════════════

;; Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket directory (alternative to TCP)
unix_socket_dir = /var/run/pgbouncer

;; ═══════════════════════════════════════════════════════════════════════════════
;; AUTHENTICATION
;; ═══════════════════════════════════════════════════════════════════════════════

;; Authentication type: trust, md5, scram-sha-256
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

;; ═══════════════════════════════════════════════════════════════════════════════
;; POOL SETTINGS
;; ═══════════════════════════════════════════════════════════════════════════════

;; Pool mode:
;; - session: Connection is assigned to client for entire session
;; - transaction: Connection is assigned per transaction (recommended for most apps)
;; - statement: Connection is assigned per statement (limited compatibility)
pool_mode = transaction

;; Maximum client connections per user/database pair
default_pool_size = 20

;; Minimum connections to keep open per pool
min_pool_size = 5

;; Reserve connections for superuser/admin operations
reserve_pool_size = 5

;; Maximum time (seconds) client can wait for a connection
reserve_pool_timeout = 3

;; Maximum client connections allowed
max_client_conn = 200

;; Maximum database connections allowed
max_db_connections = 50

;; Maximum connections per user
max_user_connections = 50

;; ═══════════════════════════════════════════════════════════════════════════════
;; TIMEOUT SETTINGS
;; ═══════════════════════════════════════════════════════════════════════════════

;; Time to wait for connecting to server (seconds)
server_connect_timeout = 10

;; Time before dropping client if login doesn't complete
client_login_timeout = 60

;; How long idle server connection is kept (seconds)
server_idle_timeout = 600

;; Query timeout (0 = disabled)
query_timeout = 0

;; Statement timeout (0 = disabled, use query_timeout from PostgreSQL)
query_wait_timeout = 120

;; Close server connection if it's been idle for this long
client_idle_timeout = 0

;; ═══════════════════════════════════════════════════════════════════════════════
;; LOGGING
;; ═══════════════════════════════════════════════════════════════════════════════

;; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

;; Pid file location
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Log level: debug, log, notice, warning, error
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

;; ═══════════════════════════════════════════════════════════════════════════════
;; ADMIN CONSOLE
;; ═══════════════════════════════════════════════════════════════════════════════

;; Admin users can connect to pgbouncer pseudo-database
admin_users = pgbouncer_admin

;; Stats users can view statistics
stats_users = pgbouncer_stats

;; ═══════════════════════════════════════════════════════════════════════════════
;; SECURITY
;; ═══════════════════════════════════════════════════════════════════════════════

;; Ignore extra parameters in startup packet
ignore_startup_parameters = extra_float_digits

;; Application name from client (useful for debugging)
application_name_add_host = 1

;; TLS settings (production)
;; server_tls_sslmode = verify-full
;; server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;; client_tls_sslmode = require
;; client_tls_key_file = /etc/pgbouncer/pgbouncer.key
;; client_tls_cert_file = /etc/pgbouncer/pgbouncer.crt
