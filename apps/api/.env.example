# ═══════════════════════════════════════════════════════════════════════════════
# AgroBridge Backend API - Environment Configuration
# Enterprise-grade traceability platform with security hardening
# ═══════════════════════════════════════════════════════════════════════════════

# ─── APPLICATION ───────────────────────────────────────────────────────────────
NODE_ENV=development
PORT=3001

# ─── CORS CONFIGURATION ────────────────────────────────────────────────────────
# Comma-separated list of allowed origins for CORS
# In production, set these to your actual frontend domains
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:4200

# Legacy FRONTEND_URL for backwards compatibility
FRONTEND_URL=http://localhost:3000

# ─── DATABASE ──────────────────────────────────────────────────────────────────
# Development
DATABASE_URL="postgresql://user:password@localhost:5432/agrobridge?schema=public"

# Production (with connection pooling)
# DATABASE_URL="postgresql://user:password@host:5432/agrobridge?connection_limit=20&pool_timeout=30&schema=public"

# ─── REDIS (for caching, token blacklist, and rate limiting) ────────────────────
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# Cache TTL overrides (optional, defaults in code)
# REDIS_TTL_BATCHES=300    # 5 minutes
# REDIS_TTL_PRODUCERS=600  # 10 minutes
# REDIS_TTL_EVENTS=120     # 2 minutes
# REDIS_TTL_LIST=60        # 1 minute

# ─── JWT CONFIGURATION ─────────────────────────────────────────────────────────
# Generate RSA keys with:
#   openssl genpkey -algorithm RSA -out jwtRS256.key -pkeyopt rsa_keygen_bits:2048
#   openssl rsa -pubout -in jwtRS256.key -out jwtRS256.key.pub
# Or use the provided script: npm run generate:keys

# Path to RSA key files (recommended for production)
JWT_PRIVATE_KEY_PATH=./jwtRS256.key
JWT_PUBLIC_KEY_PATH=./jwtRS256.key.pub

# Alternative: Inline keys (base64 encoded)
# JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
# JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# Token TTL (Time To Live)
JWT_ACCESS_TOKEN_TTL=15m
JWT_REFRESH_TOKEN_TTL=7d

# ─── BLOCKCHAIN (Polygon) ──────────────────────────────────────────────────────
POLYGON_RPC_URL=https://rpc-mumbai.maticvigil.com
CHAIN_ID=80001
WALLET_PRIVATE_KEY=

# Contract Addresses (deployed)
TRACEABILITY_REGISTRY_CONTRACT=
PRODUCER_CERTIFICATION_CONTRACT=
BATCH_TOKEN_CONTRACT=

# ─── AWS S3 (File Storage) ───────────────────────────────────────────────────
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_S3_BUCKET=agrobridge-uploads

# CloudFront CDN (optional, for faster file delivery)
AWS_CLOUDFRONT_DOMAIN=

# ─── AWS SES (Email - optional fallback for SendGrid) ────────────────────────
AWS_SES_REGION=us-east-1
AWS_SES_FROM_EMAIL=noreply@agrobridge.io

# ─── IPFS / PINATA ─────────────────────────────────────────────────────────────
PINATA_API_KEY=
PINATA_API_SECRET=
PINATA_GATEWAY_URL=https://gateway.pinata.cloud

# ─── EMAIL / SENDGRID ──────────────────────────────────────────────────────────
SENDGRID_API_KEY=
SENDGRID_FROM_EMAIL=noreply@agrobridge.io

# ─── SMS / TWILIO ──────────────────────────────────────────────────────────────
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=

# ─── PUSH NOTIFICATIONS / FIREBASE ─────────────────────────────────────────────
FIREBASE_PROJECT_ID=
FIREBASE_CLIENT_EMAIL=
FIREBASE_PRIVATE_KEY=

# ─── LOGGING ───────────────────────────────────────────────────────────────────
LOG_LEVEL=debug
# Datadog integration (optional)
DD_API_KEY=
DD_APP_KEY=

# ─── ERROR TRACKING / SENTRY ─────────────────────────────────────────────────
# Create a project at https://sentry.io and get your DSN
SENTRY_DSN=

# ─── RATE LIMITING (optional overrides) ────────────────────────────────────────
# Default values are set in code, but can be overridden here
# RATE_LIMIT_AUTH_MAX=5
# RATE_LIMIT_AUTH_WINDOW_MS=900000
# RATE_LIMIT_API_MAX=100
# RATE_LIMIT_API_WINDOW_MS=60000
# RATE_LIMIT_CREATION_MAX=50
# RATE_LIMIT_CREATION_WINDOW_MS=3600000

# ─── BACKGROUND JOB QUEUES (Bull) ───────────────────────────────────────────────
# Redis connection for queues (can use same or different DB)
REDIS_QUEUE_DB=1

# Queue configuration
QUEUE_MAX_RETRIES=3
QUEUE_RETRY_DELAY=2000

# Email queue rate limit (emails per minute)
EMAIL_RATE_LIMIT=100

# Blockchain configuration (for blockchain queue)
# BLOCKCHAIN_RPC_URL=https://polygon-mainnet.g.alchemy.com/v2/YOUR_KEY
# BLOCKCHAIN_PRIVATE_KEY=

# Bull Board Dashboard
# Access at /admin/queues (protected by admin auth)
BULL_BOARD_ENABLED=true

# ═══════════════════════════════════════════════════════════════════════════════
# FINTECH MODULE CONFIGURATION
# Cash Flow Bridge, Credit Scoring, Repayments, Collections
# ═══════════════════════════════════════════════════════════════════════════════

# ─── WHATSAPP BOT (Meta Cloud API) ───────────────────────────────────────────
# Get from: https://developers.facebook.com/apps > WhatsApp > API Setup
META_WHATSAPP_TOKEN=
META_WHATSAPP_PHONE_ID=
META_VERIFY_TOKEN=your_custom_verification_token_min_20_chars
META_WHATSAPP_API_VERSION=v18.0

# ─── COLLECTIONS (Automated Payment Reminders) ───────────────────────────────
COLLECTIONS_ENABLED=true
COLLECTIONS_CRON_SCHEDULE=0 8 * * *
COLLECTIONS_TIMEZONE=America/Mexico_City
COLLECTIONS_MAX_RETRIES=3

# ─── LATE FEES CONFIGURATION ─────────────────────────────────────────────────
LATE_FEE_RATE_PER_WEEK=0.05
LATE_FEE_MAX_PERCENTAGE=0.20
LATE_FEE_GRACE_PERIOD_DAYS=0

# ─── CREDIT SCORING ──────────────────────────────────────────────────────────
CREDIT_SCORE_EXPIRY_DAYS=30
CREDIT_SCORE_MIN_THRESHOLD=300
CREDIT_SCORE_AUTO_APPROVE_THRESHOLD=700

# ─── ADVANCE LIMITS ──────────────────────────────────────────────────────────
MAX_ADVANCE_AMOUNT_MXN=10000
MIN_ADVANCE_AMOUNT_MXN=1000
MAX_ACTIVE_ADVANCES_PER_USER=3
ADVANCE_DEFAULT_TERM_DAYS=90

# ─── STRIPE (Payment Processor) ──────────────────────────────────────────────
STRIPE_SECRET_KEY=
STRIPE_PUBLISHABLE_KEY=
STRIPE_WEBHOOK_SECRET=

# ─── MERCADOPAGO (Payment Processor - Mexico) ─────────────────────────────────
MERCADOPAGO_ACCESS_TOKEN=
MERCADOPAGO_PUBLIC_KEY=
MERCADOPAGO_WEBHOOK_SECRET=

# ─── FEATURE FLAGS ───────────────────────────────────────────────────────────
FEATURE_WHATSAPP_BOT=true
FEATURE_AUTO_COLLECTIONS=true
FEATURE_CREDIT_SCORING=true
FEATURE_ML_SCORING=false

# ═══════════════════════════════════════════════════════════════════════════════
# BACKUP & DISASTER RECOVERY CONFIGURATION
# RTO: < 1 hour | RPO: < 24 hours
# ═══════════════════════════════════════════════════════════════════════════════

# ─── S3 BACKUP STORAGE ─────────────────────────────────────────────────────────
# AWS S3 bucket for off-site backup storage
BACKUP_S3_BUCKET=agrobridge-backups
BACKUP_S3_PREFIX=agrobridge/backups
BACKUP_S3_RETENTION_DAYS=90

# ─── BACKUP SCHEDULE ───────────────────────────────────────────────────────────
# Backup retention (local volume)
BACKUP_KEEP_DAYS=30
BACKUP_KEEP_WEEKS=4
BACKUP_KEEP_MONTHS=6

# ─── BACKUP HEALTH MONITORING ──────────────────────────────────────────────────
# Maximum backup age before alerting (in hours)
MAX_BACKUP_AGE_HOURS=26

# Minimum backup file size to consider valid (in KB)
MIN_BACKUP_SIZE_KB=100

# ─── ALERT NOTIFICATIONS ───────────────────────────────────────────────────────
# Slack webhook for backup alerts
SLACK_WEBHOOK_URL=

# Email address for backup alerts
ALERT_EMAIL=ops@agrobridge.io
