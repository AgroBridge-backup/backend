# ═══════════════════════════════════════════════════════════════════════════════
# AgroBridge Backend - Environment Configuration Template
# ═══════════════════════════════════════════════════════════════════════════════
# SECURITY WARNING: Never commit actual secrets to version control!
# Copy this file to .env and fill in your actual values.
#
# Legend:
#   [REQUIRED]  - Must be set for the application to start
#   [OPTIONAL]  - Has defaults or is feature-specific
#   [CRITICAL]  - Security-sensitive, use strong values in production
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# APPLICATION [REQUIRED]
# ─────────────────────────────────────────────────────────────────────────────────
NODE_ENV=development                    # development | test | production
PORT=3001                               # API server port
API_PORT=3000                           # Docker exposed port

# ─────────────────────────────────────────────────────────────────────────────────
# DATABASE [REQUIRED] [CRITICAL]
# ─────────────────────────────────────────────────────────────────────────────────
# PostgreSQL connection string
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=public
POSTGRES_USER=                          # [REQUIRED] Database username
POSTGRES_PASSWORD=                      # [REQUIRED] [CRITICAL] Min 16 chars, use: openssl rand -base64 24
POSTGRES_DB=agrobridge                  # Database name
POSTGRES_PORT=5432                      # PostgreSQL port

# Full connection URL (constructed from above or set directly)
DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}?schema=public"

# ─────────────────────────────────────────────────────────────────────────────────
# JWT AUTHENTICATION [REQUIRED] [CRITICAL]
# ─────────────────────────────────────────────────────────────────────────────────
# Generate with: openssl rand -base64 64
JWT_SECRET=                             # [REQUIRED] [CRITICAL] Min 64 chars
JWT_REFRESH_SECRET=                     # [REQUIRED] [CRITICAL] Min 64 chars (different from JWT_SECRET!)

# Token expiration times
JWT_ACCESS_TOKEN_TTL=15m                # Access token lifetime (15 minutes recommended)
JWT_REFRESH_TOKEN_TTL=7d                # Refresh token lifetime (7 days recommended)

# Alternative: RSA keys (recommended for production)
# Generate with:
#   openssl genpkey -algorithm RSA -out jwtRS256.key -pkeyopt rsa_keygen_bits:2048
#   openssl rsa -pubout -in jwtRS256.key -out jwtRS256.key.pub
# JWT_PRIVATE_KEY_PATH=./jwtRS256.key
# JWT_PUBLIC_KEY_PATH=./jwtRS256.key.pub

# ─────────────────────────────────────────────────────────────────────────────────
# REDIS [REQUIRED for production]
# ─────────────────────────────────────────────────────────────────────────────────
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=                         # [CRITICAL] Set in production
REDIS_DB=0
REDIS_URL=redis://localhost:6379        # Full URL (alternative to individual settings)

# Cache TTL overrides (seconds)
# REDIS_TTL_BATCHES=300                 # 5 minutes
# REDIS_TTL_PRODUCERS=600               # 10 minutes
# REDIS_TTL_EVENTS=120                  # 2 minutes

# ─────────────────────────────────────────────────────────────────────────────────
# CORS CONFIGURATION [REQUIRED]
# ─────────────────────────────────────────────────────────────────────────────────
# Comma-separated list of allowed origins
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
FRONTEND_URL=http://localhost:3000      # Primary frontend URL

# ─────────────────────────────────────────────────────────────────────────────────
# BLOCKCHAIN - POLYGON [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
BLOCKCHAIN_ENABLED=false                # Enable blockchain features

# Network configuration
POLYGON_RPC_URL=https://rpc-mumbai.maticvigil.com  # Mumbai testnet
CHAIN_ID=80001                          # 80001=Mumbai, 137=Mainnet
BLOCKCHAIN_NETWORK=polygon
BLOCKCHAIN_EXPLORER_URL=https://polygonscan.com

# Wallet [CRITICAL] - Never expose in logs!
WALLET_PRIVATE_KEY=                     # [CRITICAL] Hex format, no 0x prefix

# Contract addresses (deployed)
TRACEABILITY_REGISTRY_CONTRACT=
PRODUCER_CERTIFICATION_CONTRACT=
BATCH_TOKEN_CONTRACT=
INVOICE_REGISTRY_CONTRACT_ADDRESS=
REFERRAL_PROGRAM_CONTRACT_ADDRESS=

# ─────────────────────────────────────────────────────────────────────────────────
# AWS S3 - FILE STORAGE [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=                      # [CRITICAL] IAM credentials
AWS_SECRET_ACCESS_KEY=                  # [CRITICAL] IAM credentials
AWS_S3_BUCKET=agrobridge-uploads
S3_BUCKET_NAME=agrobridge-uploads

# CloudFront CDN (optional)
AWS_CLOUDFRONT_DOMAIN=

# ─────────────────────────────────────────────────────────────────────────────────
# IPFS / PINATA [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
PINATA_API_KEY=
PINATA_API_SECRET=                      # [CRITICAL]
PINATA_GATEWAY_URL=https://gateway.pinata.cloud

# ─────────────────────────────────────────────────────────────────────────────────
# STRIPE PAYMENTS [OPTIONAL] [CRITICAL]
# ─────────────────────────────────────────────────────────────────────────────────
STRIPE_SECRET_KEY=                      # [CRITICAL] sk_test_... or sk_live_...
STRIPE_PUBLISHABLE_KEY=                 # pk_test_... or pk_live_...
STRIPE_WEBHOOK_SECRET=                  # [CRITICAL] whsec_...

# ─────────────────────────────────────────────────────────────────────────────────
# MERCADOPAGO [OPTIONAL] [CRITICAL]
# ─────────────────────────────────────────────────────────────────────────────────
MERCADOPAGO_ACCESS_TOKEN=               # [CRITICAL]
MERCADOPAGO_PUBLIC_KEY=
MERCADOPAGO_WEBHOOK_SECRET=             # [CRITICAL]

# ─────────────────────────────────────────────────────────────────────────────────
# EMAIL - SENDGRID [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
SENDGRID_API_KEY=                       # [CRITICAL] SG.xxx
SENDGRID_FROM_EMAIL=noreply@agrobridge.io

# Fallback: AWS SES
AWS_SES_REGION=us-east-1
AWS_SES_FROM_EMAIL=noreply@agrobridge.io

# ─────────────────────────────────────────────────────────────────────────────────
# SMS - TWILIO [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
TWILIO_ACCOUNT_SID=                     # [CRITICAL]
TWILIO_AUTH_TOKEN=                      # [CRITICAL]
TWILIO_PHONE_NUMBER=+1234567890

# ─────────────────────────────────────────────────────────────────────────────────
# WHATSAPP BOT - META CLOUD API [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
META_WHATSAPP_TOKEN=                    # [CRITICAL]
META_WHATSAPP_PHONE_ID=
META_WHATSAPP_PHONE_NUMBER_ID=
META_VERIFY_TOKEN=                      # Min 20 chars
META_WEBHOOK_VERIFY_TOKEN=
META_WHATSAPP_API_VERSION=v18.0

# ─────────────────────────────────────────────────────────────────────────────────
# FIREBASE PUSH NOTIFICATIONS [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
FIREBASE_PROJECT_ID=
FIREBASE_CLIENT_EMAIL=
FIREBASE_PRIVATE_KEY=                   # [CRITICAL] JSON escaped

# ─────────────────────────────────────────────────────────────────────────────────
# MONITORING & LOGGING
# ─────────────────────────────────────────────────────────────────────────────────
LOG_LEVEL=debug                         # debug | info | warn | error

# Sentry Error Tracking
SENTRY_DSN=                             # https://xxx@sentry.io/xxx

# Datadog APM (optional)
DD_API_KEY=
DD_APP_KEY=

# ─────────────────────────────────────────────────────────────────────────────────
# RATE LIMITING [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
# RATE_LIMIT_AUTH_MAX=5                 # Max auth attempts
# RATE_LIMIT_AUTH_WINDOW_MS=900000      # 15 minutes
# RATE_LIMIT_API_MAX=100                # Max API calls
# RATE_LIMIT_API_WINDOW_MS=60000        # 1 minute
# RATE_LIMIT_CREATION_MAX=50            # Max creations
# RATE_LIMIT_CREATION_WINDOW_MS=3600000 # 1 hour

# ─────────────────────────────────────────────────────────────────────────────────
# BACKGROUND JOBS - BULL QUEUES [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
REDIS_QUEUE_DB=1
QUEUE_MAX_RETRIES=3
QUEUE_RETRY_DELAY=2000
EMAIL_RATE_LIMIT=100
BULL_BOARD_ENABLED=true

# ─────────────────────────────────────────────────────────────────────────────────
# FINTECH MODULE [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
# Collections
COLLECTIONS_ENABLED=true
COLLECTIONS_CRON_SCHEDULE=0 8 * * *
COLLECTIONS_TIMEZONE=America/Mexico_City
COLLECTIONS_MAX_RETRIES=3

# Late Fees
LATE_FEE_RATE_PER_WEEK=0.05
LATE_FEE_MAX_PERCENTAGE=0.20
LATE_FEE_GRACE_PERIOD_DAYS=0

# Credit Scoring
CREDIT_SCORE_EXPIRY_DAYS=30
CREDIT_SCORE_MIN_THRESHOLD=300
CREDIT_SCORE_AUTO_APPROVE_THRESHOLD=700

# Advance Limits (MXN)
MAX_ADVANCE_AMOUNT_MXN=10000
MIN_ADVANCE_AMOUNT_MXN=1000
MAX_ACTIVE_ADVANCES_PER_USER=3
ADVANCE_DEFAULT_TERM_DAYS=90

# ─────────────────────────────────────────────────────────────────────────────────
# FEATURE FLAGS [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
FEATURE_WHATSAPP_BOT=true
FEATURE_AUTO_COLLECTIONS=true
FEATURE_CREDIT_SCORING=true
FEATURE_ML_SCORING=false

# ─────────────────────────────────────────────────────────────────────────────────
# EXTERNAL INTEGRATIONS [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
# Facturama (Mexican invoicing)
FACTURAMA_API_URL=https://apisandbox.facturama.mx
FACTURAMA_USER=
FACTURAMA_PASSWORD=                     # [CRITICAL]

# Public URLs
VERIFY_BASE_URL=https://verify.agrobridge.io
APP_BASE_URL=https://api.agrobridge.io

# ─────────────────────────────────────────────────────────────────────────────────
# ADMIN ACCESS [OPTIONAL]
# ─────────────────────────────────────────────────────────────────────────────────
ADMIN_USERNAME=
ADMIN_PASSWORD=                         # [CRITICAL] Min 16 chars

# ═══════════════════════════════════════════════════════════════════════════════
# END OF CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
